<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f13">
<title>NetGains V38</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* --- 1. VARIABLES & RESET --- */
  :root { 
    --bg: #0f0f13; --card: #1a1a24; --text: #ffffff; 
    --accent: #ff4757; --success: #2ed573; --danger: #ff4757;
    --drop: #ff6b81; --super: #a29bfe; --assist: #00d2d3; --cardio: #ffa502; 
    --input-bg: #121212; --border: #333;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important; }
  
  body { margin: 0; padding: 0; background-color: var(--bg); color: var(--text); overflow-x: hidden; padding-bottom: 90px; }
  .hidden { display: none !important; }
  
  /* BUTTONS */
  .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 13px; margin-top: 10px; transition: 0.1s; letter-spacing: 0.5px; }
  .btn:active { transform: scale(0.98); }
  .btn-main { background: linear-gradient(135deg, #ff4757, #ff6b81); color: white; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
  .btn-sec { background: #333; color: white; border: 1px solid #444; }
  .btn-ghost { background: transparent; border: 1px dashed #444; color: #666; font-size: 10px; padding: 6px 10px; width: auto; display: inline-block; cursor: pointer; border-radius: 6px; font-weight: 700; text-transform: uppercase; }
  .btn-sm { padding: 8px; font-size: 11px; width: auto; display: inline-block; margin: 0; }
  
  /* STATIC LBS BADGE */
  #lbs-badge { position: fixed; top: 15px; right: 15px; background: #222; border: 1px solid #444; color: #666; padding: 6px 10px; border-radius: 20px; font-weight: 800; font-size: 10px; z-index: 9999; pointer-events: none; }

  h1 { text-align: center; margin: 25px 0 5px; font-size: 26px; letter-spacing: -1px; font-weight: 900; color: white; text-transform: uppercase; }
  .brand-span { color: var(--accent); }
  .sub { text-align: center; color: #666; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 25px; font-weight: 700; }
  
  /* INPUTS */
  input { background: var(--input-bg); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; width: 100%; font-size: 16px; margin-bottom: 5px; font-weight: 600; text-align: center; position: relative; z-index: 1; }
  input:focus { outline:none; border-color: var(--accent); }
  .input-wrapper { position: relative; width: 100%; }
  .input-wrapper input { padding-right: 35px; } 
  .input-unit { position: absolute; right: 8px; top: 42%; transform: translateY(-50%); color: #555; font-size: 9px; pointer-events: none; font-weight: 800; text-transform: uppercase; z-index: 2; }

  /* VIEWS */
  .view { padding: 20px; max-width: 600px; margin: 0 auto; animation: fade 0.3s; }
  @keyframes fade { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

  /* COMPONENTS */
  .gym-selector { background: #222; border: 1px solid var(--border); padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; cursor: pointer; transition: 0.1s; }
  .gym-label { font-size: 10px; color: #666; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; margin-bottom: 4px; }
  .gym-name { font-weight: 900; font-size: 18px; color: var(--accent); text-transform: uppercase; letter-spacing: -0.5px; }
  .gym-arrow { color: #555; font-size: 12px; font-weight: bold; }

  .day-card { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 16px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); transition: 0.1s; }
  .icon-btn { background: #222; border: 1px solid #444; color: #ccc; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }

  /* WORKOUT ROWS */
  .ex-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
  .ex-top { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: flex-start; }
  .ex-name { font-weight: 800; font-size: 16px; margin-right: 10px; flex-grow: 1; letter-spacing: -0.3px; }
  .ex-tools { display: flex; gap: 10px; align-items: center; flex-shrink: 0; margin-left: 10px; }
  .ex-hist { font-size: 10px; color: var(--success); margin-bottom: 10px; display: flex; gap: 10px; font-weight: 700; }
  .hist-badge { background: rgba(46, 213, 115, 0.1); padding: 3px 8px; border-radius: 6px; border: 1px solid rgba(46, 213, 115, 0.3); letter-spacing: 0.5px; font-family: monospace; font-size: 10px; }
  
  .set-row { display: grid; grid-template-columns: 35px 1fr 40px 1fr 30px 30px; gap: 6px; align-items: center; margin-bottom: 8px; }
  .set-num { text-align: center; font-weight: 700; color: #666; font-size: 12px; } 
  .cardio-row { display: grid; grid-template-columns: 30px 1fr 1fr 1fr 30px; gap: 6px; align-items: center; margin-bottom: 8px; }
  
  /* CALC BUTTON - THE FIX */
  .calc-btn { background: #222; border: 1px solid #444; color: var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; height: 42px; font-size: 14px; position: relative; z-index: 200; pointer-events: auto; }
  .calc-btn:active { background: #333; transform: scale(0.95); }
  
  .del-btn { background: none; border: none; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .toggle-lr { font-size: 11px; background: #222; color: #aaa; padding: 8px 12px; border-radius: 6px; border: 1px solid #444; cursor: pointer; font-weight: 800; display: inline-block; transition: 0.1s; }
  .toggle-lr.active { background: var(--accent); color: white; border-color: var(--accent); }
  .menu-btn { background: #222; border: 1px solid #444; color: #888; border-radius: 6px; height: 42px; width: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; padding-bottom: 5px; }

  /* FLASHY SET TAGS */
  .set-group-box { padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
  .set-group-drop { background: rgba(255, 107, 129, 0.20); border: 1px solid var(--drop); }
  .set-group-super { background: rgba(162, 155, 254, 0.20); border: 1px solid var(--super); }
  .set-group-assist { background: rgba(0, 210, 211, 0.20); border: 1px solid var(--assist); }

  .label-drop { color: var(--drop); font-weight: 900; font-size: 10px; letter-spacing: 0.5px; }
  .label-super { color: white; font-weight: 900; font-size: 10px; letter-spacing: 0.5px; }
  .label-assist { color: black; font-weight: 900; font-size: 10px; letter-spacing: 0.5px; }

  /* SHELF */
  .shelf-header { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; border-top: 1px solid #333; padding-top: 20px; margin-bottom: 15px; }
  .shelf-title { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; }
  .edit-btn { font-size: 10px; font-weight: 800; color: var(--accent); background: none; border: none; cursor: pointer; padding: 5px; text-transform: uppercase; letter-spacing: 1px; }
  
  .tile-grid { display: flex; flex-wrap: wrap; gap: 8px; }
  .tile { display: inline-flex; align-items: center; justify-content: center; background: #222; border: 1px solid #333; color: #ccc; padding: 12px 18px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 700; transition: 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .tile:active { background: var(--accent); color: white; border-color: var(--accent); transform: translateY(1px); }
  .tile.deleting { border-color: var(--danger); color: var(--danger); background: rgba(255, 71, 87, 0.1); }
  .tile-add { border: 1px dashed #666; color: #888; background: transparent; box-shadow: none; }

  /* GRAPH */
  .chart-container { position: relative; height: 300px; width: 100%; background: #111; border: 1px solid #333; border-radius: 12px; padding: 10px; margin-top: 15px; }
  
  /* MODALS */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .modal-box { background: #1e1e1e; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
  .modal-full { background: #0f0f13; width: 100%; height: 100%; max-width: none; border-radius: 0; padding: 20px; overflow-y: auto; }
  .close-x { position: absolute; top: 15px; right: 15px; color: #666; font-size: 20px; cursor: pointer; font-weight: bold; }
  
  /* TAGS */
  .tag-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .chip { padding: 8px 14px; background: #222; border: 1px solid #444; border-radius: 20px; font-size: 11px; color: #ccc; cursor: pointer; font-weight: 600; }
  .chip:active { background: var(--accent); color: white; }
  .chip-add { border-style: dashed; color: #888; }

  /* PLATE VIZ */
  .barbell-viz { display: flex; align-items: center; justify-content: center; height: 100px; background: #111; margin-bottom: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #333; position: relative; }
  .sleeve { height: 10px; width: 90%; background: #555; position: absolute; border-radius: 5px; z-index: 1; }
  .plate-stack { display: flex; align-items: center; gap: 2px; z-index: 2; }
  .viz-plate { display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; color: black; border-radius: 2px; height: 0; transition: 0.2s; border: 1px solid rgba(0,0,0,0.3); }
  .vp-45 { height: 90px; width: 20px; background: #0984e3; color: white; } 
  .vp-35 { height: 80px; width: 18px; background: #fdcb6e; } 
  .vp-25 { height: 70px; width: 16px; background: #00b894; } 
  .vp-10 { height: 50px; width: 14px; background: #dfe6e9; } 
  .vp-5  { height: 40px; width: 12px; background: #d63031; color: white; } 
  .vp-2_5{ height: 30px; width: 10px; background: #636e72; color: white; }
  .plate-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
  .p-btn { background: #222; border: 1px solid #444; color: white; padding: 15px 0; border-radius: 8px; font-weight: bold; cursor: pointer; }
  .p-btn:active { background: #444; }

  /* PICKER */
  .picker-section { margin-bottom: 25px; }
  .picker-label { font-size: 11px; color: #666; font-weight: bold; letter-spacing: 1px; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid #222; padding-bottom: 5px; }
  .picker-item { background: #1a1a24; border: 1px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 8px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .picker-item:active { background: var(--accent); color: black; }
  .folder-tag { font-size: 9px; padding: 3px 6px; background: #333; border-radius: 4px; color: #aaa; margin-left: 10px; }

  /* PROGRAM CSS */
  .week { background: var(--card); border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; overflow: hidden; transition: 0.3s; }
  .week-head { display: flex; justify-content: space-between; padding: 15px; background: #222; border-bottom: 1px solid #333; font-weight: bold; }
  .day-row { padding: 15px; border-bottom: 1px solid #222; position: relative; cursor: pointer; }
  .day-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .day-left-grp { display: flex; align-items: center; gap: 10px; }
  
  .day-check { width: 24px; height: 24px; border: 2px solid #555; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; z-index: 10; cursor: pointer; background: #111; }
  .day-check.checked { background: var(--success); border-color: var(--success); }
  .day-check.checked::after { content: '‚úì'; color: black; font-weight: bold; font-size: 14px; }
  
  .day-type { font-size: 9px; padding: 3px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; }
  .type-h { background: #ff4757; color: white; } 
  .type-l { background: #2ed573; color: black; } 
  .type-m { background: #ffa502; color: black; }
  .lift-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 4px; }
  .lift-name { color: #888; width: 40px; font-weight: bold; }
  .lift-nums { color: white; font-family: monospace; letter-spacing: -0.5px; }
  .calc-trigger { color: var(--success); cursor: pointer; border-bottom: 1px dashed #444; }
  .warmup-drop { background: #111; padding: 10px; border-top: 1px dashed #333; display: none; margin-top:10px; }
  .warmup-drop.open { display: block; animation: slideDown 0.2s ease-out; }
  .warmup-header { font-size: 10px; color: var(--accent); font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
  .warmup-line { font-size: 11px; color: #aaa; margin-bottom: 3px; font-family: monospace; }
  @keyframes slideDown { from{opacity:0; transform:translateY(-5px)} to{opacity:1; transform:translateY(0)} }
  .chk-box { width: 20px; height: 20px; border: 2px solid #444; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
  .chk-box.checked { background: #444; border-color: #444; }
  .chk-box.checked::after { content: '‚úì'; color: #888; font-weight: bold; font-size: 12px; }
  .week-content.dimmed { opacity: 0.3; pointer-events: none; filter: grayscale(100%); text-decoration: line-through; }
  .log-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .log-lbl { font-size: 10px; color: #888; text-align: center; }

  /* SET BUTTONS */
  .btn-drop { background: var(--drop); color: white; border: none; font-weight: 800; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
  .btn-super { background: var(--super); color: white; border: none; font-weight: 800; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
  .btn-assist { background: var(--assist); color: black; border: none; font-weight: 800; }

  .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: #181818; border-top: 1px solid #333; display: grid; grid-template-columns: 1fr 1fr 1fr; z-index: 1000; padding-bottom: 20px; }
  .nav-btn { background: none; border: none; color: #666; font-size: 10px; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
  .nav-btn.active { color: var(--accent); }
  
  #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid #333; padding: 10px 20px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 3000; font-size: 12px; font-weight: bold; }
  #toast.show { opacity: 1; transform: translate(-50%, -10px); }
</style>
</head>
<body>

<div id="lbs-badge">LBS</div>
<div id="debug-status" style="position:fixed; bottom:90px; right:10px; font-size:9px; color:#333; z-index:9000;">System: Active</div>
<div id="toast">Saved</div>

<div id="modal-calc" class="modal-overlay">
  <div class="modal-box">
    <div class="close-x" onclick="window.closeCalc()">‚úï</div>
    <h3>Plate Math</h3>
    <div class="barbell-viz"><div class="sleeve"></div><div class="plate-stack" id="plate-stack-display"></div></div>
    <input type="text" inputmode="decimal" id="calc-total" oninput="window.manualCalcUpdate(this.value)">
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button id="mode-bar" class="btn btn-sm" style="background:var(--success); color:black;" onclick="window.setCalcMode('bar')">BARBELL</button>
        <button id="mode-single" class="btn btn-sm" style="background:#333;" onclick="window.setCalcMode('single')">SINGLE</button>
    </div>
    <div id="plate-btn-grid" class="plate-grid"></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="btn btn-sec" onclick="window.resetCalc()">Clear</button>
        <button class="btn btn-main" onclick="window.applyCalc()">Use</button>
    </div>
  </div>
</div>

<div id="modal-program-log" class="modal-overlay">
  <div class="modal-box">
    <div class="close-x" onclick="document.getElementById('modal-program-log').style.display='none'">‚úï</div>
    <h3>Log Results</h3>
    <div style="margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><b style="color:var(--accent); font-size:12px;">SQUAT</b></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="input-wrapper"><input type="number" id="log-s-w"><span class="input-unit lbl-unit">LBS</span></div>
            <div class="input-wrapper"><input type="number" id="log-s-r"><span class="input-unit">REPS</span></div>
        </div>
    </div>
    <div style="margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><b style="color:var(--accent); font-size:12px;">BENCH</b></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="input-wrapper"><input type="number" id="log-b-w"><span class="input-unit lbl-unit">LBS</span></div>
            <div class="input-wrapper"><input type="number" id="log-b-r"><span class="input-unit">REPS</span></div>
        </div>
    </div>
    <div style="margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><b style="color:var(--accent); font-size:12px;">DEADLIFT</b></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="input-wrapper"><input type="number" id="log-d-w"><span class="input-unit lbl-unit">LBS</span></div>
            <div class="input-wrapper"><input type="number" id="log-d-r"><span class="input-unit">REPS</span></div>
        </div>
    </div>
    <button class="btn btn-main" onclick="window.confirmProgramLog()">Save to History</button>
  </div>
</div>

<div id="modal-new-ex" class="modal-overlay">
  <div class="modal-box">
    <div class="close-x" onclick="document.getElementById('modal-new-ex').style.display='none'">‚úï</div>
    <h3>New Exercise</h3>
    <input type="text" id="new-ex-name" placeholder="Name...">
    <div id="tag-area" class="tag-grid"></div>
    <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="btn btn-main" onclick="window.confirmNewEx('str')">STRENGTH</button>
        <button class="btn btn-sec" style="border-color:var(--cardio); color:var(--cardio);" onclick="window.confirmNewEx('cardio')">CARDIO</button>
    </div>
  </div>
</div>

<div id="modal-manual-import" class="modal-overlay">
  <div class="modal-box">
    <div class="close-x" onclick="document.getElementById('modal-manual-import').style.display='none'">‚úï</div>
    <h3>Import</h3>
    <textarea id="import-area" style="width:100%; height:80px; background:#111; color:#0f0; margin-bottom:10px;" placeholder="Paste code..."></textarea>
    <button class="btn btn-main" onclick="window.runManualImport()">Import</button>
  </div>
</div>

<div id="modal-set-opt" class="modal-overlay">
  <div class="modal-box">
    <h3 style="margin-bottom:15px;">Link Set</h3>
    <button class="btn btn-drop" style="width:100%; margin-bottom:10px; padding:12px;" onclick="window.applySetType('drop')">üíß Drop Set</button>
    <button class="btn btn-super" style="width:100%; margin-bottom:10px; padding:12px;" onclick="window.applySetType('super')">üîó Superset</button>
    <button class="btn btn-assist" style="width:100%; margin-bottom:10px; padding:12px;" onclick="window.applySetType('assist')">ü§ù Assisted</button>
    <button class="btn btn-sec" style="margin-top:20px" onclick="document.getElementById('modal-set-opt').style.display='none'">Cancel</button>
  </div>
</div>

<div id="modal-share" class="modal-overlay">
  <div class="modal-box">
    <div class="close-x" onclick="document.getElementById('modal-share').style.display='none'">‚úï</div>
    <h3 style="text-align:center">Share</h3>
    <div id="qrcode" style="display:flex; justify-content:center; margin:15px 0;"></div>
    <button class="btn btn-main" onclick="window.copyShareCode()">Copy Code</button>
  </div>
</div>

<div id="modal-stats-picker" class="modal-overlay">
    <div class="modal-box modal-full">
        <div class="close-x" onclick="document.getElementById('modal-stats-picker').style.display='none'">‚úï</div>
        <h3 style="margin-bottom:15px;">Select Data</h3>
        <input type="text" id="picker-search" placeholder="Search..." oninput="window.renderPickerItems(this.value)" style="margin-bottom:20px; font-size:18px; width:100%; padding:15px;">
        <div id="picker-content"></div>
    </div>
</div>

<div id="modal-input-overlay" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modal-title">Input</h3>
        <input type="text" id="modal-input">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <button class="btn btn-sec" onclick="window.closeInputModal()">Cancel</button>
            <button class="btn btn-main" id="modal-ok">Save</button>
        </div>
    </div>
</div>

<div id="modal-confirm-overlay" class="modal-overlay">
    <div class="modal-box">
        <h3>Confirm</h3>
        <p id="confirm-desc">Are you sure?</p>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <button class="btn btn-sec" onclick="window.closeConfirmModal()">Cancel</button>
            <button class="btn btn-main" id="confirm-ok" style="background:#333">Yes</button>
        </div>
    </div>
</div>

<div id="view-prog" class="view">
  <h1>NETGAINS <span class="brand-span">V38</span></h1>
  <p class="sub">BAECHLE ENGINE</p>
  <div style="background:#222; padding:15px; border-radius:12px; margin-bottom:20px;">
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
        <div><label style="font-size:10px; color:#888">SQUAT</label><input type="number" id="prog-s" placeholder="-" oninput="window.saveProgramInputs()"></div>
        <div><label style="font-size:10px; color:#888">BENCH</label><input type="number" id="prog-b" placeholder="-" oninput="window.saveProgramInputs()"></div>
        <div><label style="font-size:10px; color:#888">DEAD</label><input type="number" id="prog-d" placeholder="-" oninput="window.saveProgramInputs()"></div>
    </div>
    <button class="btn btn-main" onclick="window.genProgram()">Update Cycle</button>
  </div>
  <div id="schedule-area"></div>
  <button class="btn btn-sec" style="margin-top:30px; border-style:dashed; color:#ff4757;" onclick="window.resetProgram()">‚ö† Reset Program</button>
</div>

<div id="view-log" class="view hidden">
  <h1>LOG</h1>
  <div id="split-manager">
      <div class="gym-selector" onclick="window.showGymManager()">
          <div><div class="gym-label">CURRENT LOCATION</div><div class="gym-name" id="current-gym-display">Main Gym</div></div>
          <div style="color:#666">‚ñº</div>
      </div>
      <button class="btn btn-sec" onclick="window.openManualImport()" style="margin-bottom:20px;">üì• IMPORT CODE</button>
      <div id="my-split-list"></div>
      <button class="btn btn-sec" style="border-style:dashed; color:#888;" onclick="window.promptAddDay()">+ NEW FOLDER</button>
  </div>
  <div id="gym-manager" class="hidden">
      <h3>Manage Gyms</h3>
      <div id="gym-list"></div>
      <button class="btn btn-sec" style="border-style:dashed; margin-top:15px;" onclick="window.promptAddGym()">+ Add Gym</button>
      <button class="btn btn-sec" style="margin-top:20px;" onclick="window.closeGymManager()">Back</button>
  </div>
  <div id="session-logger" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <button class="btn btn-sec btn-sm" onclick="window.closeSession()">‚Üê Back</button>
        <h2 id="session-title" style="margin:0; font-size:18px;"></h2>
        <button class="btn-ghost" onclick="window.clearCart()">Clear</button>
      </div>
      <div id="active-workout-area"></div>
      <button class="btn btn-main" onclick="window.finishSession()">Finish & Save</button>
      <div class="shelf-header">
          <span class="shelf-title">EXERCISE LIBRARY</span>
          <button id="edit-lib-btn" class="edit-btn" onclick="window.toggleEditMode()">‚úé EDIT</button>
      </div>
      <div id="tile-area" class="tile-grid"></div>
  </div>
</div>

<div id="view-stats" class="view hidden">
    <h1>STATS</h1>
    <div style="background:#222; padding:15px; border-radius:12px;">
      <button class="btn btn-sec" id="stats-picker-btn" onclick="window.openStatsPicker()" style="margin-top:0; margin-bottom:15px; border-color:#555; text-align:left; display:flex; justify-content:space-between;">
          <span id="stats-current-label">Select Data...</span>
          <span>‚ñº</span>
      </button>
      <div class="chart-container"><canvas id="perfChart"></canvas></div>
      <div id="stat-details" style="margin-top:15px; font-size:12px; color:#888; text-align:center;"></div>
    </div>
    <div style="margin-top:30px; text-align:center;">
        <button class="btn btn-sec" onclick="window.exportCSV()">Export Data</button>
        <div style="margin-top:20px; font-size:9px; color:#444; text-decoration:underline; cursor:pointer;" onclick="localStorage.clear();location.reload()">System Reset</div>
    </div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="window.goTab('prog', this)"><span>üìä</span> PROGRAM</button>
    <button class="nav-btn" onclick="window.goTab('log', this)"><span>üìù</span> LOG</button>
    <button class="nav-btn" onclick="window.goTab('stats', this)"><span>üìà</span> STATS</button>
</div>

<script>
// --- GLOBAL INIT ---
const DB_KEY = 'netgains_v38_db';
let DATA = { 
    unit:'lbs', 
    inputs:{s:'',b:'',d:''}, 
    progState:{}, 
    history:[], 
    currentGym: 'Main Gym', 
    gyms: { 'Main Gym': {folders:[], library:{}} }, 
    activeCart: [], 
    sessionData: {},
    customTags: [],
    exTypes: {}
};

try {
    const saved = localStorage.getItem(DB_KEY);
    if(saved) {
        const parsed = JSON.parse(saved);
        DATA = { ...DATA, ...parsed };
        if(!DATA.gyms['Main Gym']) DATA.gyms['Main Gym'] = {folders:[], library:{}};
    }
} catch(e) { console.log("Resetting Data"); }

function initUI() {
    const sIn = document.getElementById('prog-s');
    const bIn = document.getElementById('prog-b');
    const dIn = document.getElementById('prog-d');
    if(sIn) sIn.value = DATA.inputs.s;
    if(bIn) bIn.value = DATA.inputs.b;
    if(dIn) dIn.value = DATA.inputs.d;
    updateUnitBtn();
    genProgram();
    renderDays(); 
}

// --- CORE ---
window.saveData = function() { localStorage.setItem(DB_KEY,JSON.stringify(DATA)); }
window.saveSession = function() { localStorage.setItem('activeCart',JSON.stringify(activeCart)); localStorage.setItem('sessionData',JSON.stringify(sessionData)); }

// --- NAV ---
window.goTab = function(t, btn) {
    document.querySelectorAll('.view').forEach(e => e.classList.add('hidden'));
    document.getElementById('view-'+t).classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
    btn.classList.add('active');
}

function updateUnitBtn() {
    // Locked to LBS
    const ph = "LBS";
    document.getElementById('prog-s').placeholder = ph;
    document.getElementById('prog-b').placeholder = ph;
    document.getElementById('prog-d').placeholder = ph;
    document.querySelectorAll('.lbl-unit').forEach(e => e.innerText = ph);
    document.querySelectorAll('.input-unit').forEach(e => {
        if(e.innerText === 'LBS' || e.innerText === 'KG') e.innerText = ph;
    });
}

// --- PROGRAM ENGINE ---
window.saveProgramInputs = function(){
    DATA.inputs.s = document.getElementById('prog-s').value;
    DATA.inputs.b = document.getElementById('prog-b').value;
    DATA.inputs.d = document.getElementById('prog-d').value;
    window.saveData();
}

window.loadProgramInputs = function(){
    if(DATA.inputs.s && DATA.inputs.b && DATA.inputs.d) window.genProgram();
}

window.resetProgram = function(){
    window.showConfirm("Reset Cycle?", ()=>{
        DATA.progState = {};
        document.getElementById('prog-s').value = "";
        document.getElementById('prog-b').value = "";
        document.getElementById('prog-d').value = "";
        DATA.inputs = {};
        window.saveData();
        document.getElementById('schedule-area').innerHTML = "";
    });
}

window.toggleWarmup = function(el){
    const drop = el.querySelector('.warmup-drop');
    if(drop) { drop.classList.toggle('open'); }
}

window.openQuickCalc = function(weight, event) {
    if(event) event.stopPropagation(); 
    calcTarget = null; 
    window.setCalcMode('bar'); 
    document.getElementById('calc-total').value = weight;
    window.manualCalcUpdate(weight); 
    document.getElementById('modal-plate-calc').style.display='flex';
}

let pendingLog = null;
window.openProgramLogModal = function(sW, bW, dW, sR, bR, dR, dayKey, event){
    event.stopPropagation(); 
    pendingLog = { dayKey };
    document.getElementById('log-s-w').value = sW; document.getElementById('log-s-r').value = sR;
    document.getElementById('log-b-w').value = bW; document.getElementById('log-b-r').value = bR;
    document.getElementById('log-d-w').value = dW; document.getElementById('log-d-r').value = dR;
    const u = DATA.unit.toUpperCase();
    document.querySelectorAll('.lbl-unit').forEach(e => e.innerText = u);
    document.getElementById('modal-program-log').style.display = 'flex';
}

window.confirmProgramLog = function(){
    if(!pendingLog) return;
    const sW = parseFloat(document.getElementById('log-s-w').value); const sR = parseFloat(document.getElementById('log-s-r').value);
    const bW = parseFloat(document.getElementById('log-b-w').value); const bR = parseFloat(document.getElementById('log-b-r').value);
    const dW = parseFloat(document.getElementById('log-d-w').value); const dR = parseFloat(document.getElementById('log-d-r').value);
    const t=new Date().toISOString().split('T')[0];
    
    DATA.history.push({date:t, ex:"Squat", w:sW, r:sR, rm:Math.round(sW*(1+0.033*sR))});
    DATA.history.push({date:t, ex:"Bench Press", w:bW, r:bR, rm:Math.round(bW*(1+0.033*bR))});
    DATA.history.push({date:t, ex:"Deadlift", w:dW, r:dR, rm:Math.round(dW*(1+0.033*dR))});
    
    DATA.progState[pendingLog.dayKey] = true;
    window.saveData();
    document.getElementById('modal-program-log').style.display = 'none';
    window.genProgram();
    window.showToast("Logged!");
}

window.toggleManualWeek = function(wKey, el, event){
    event.stopPropagation();
    const done = el.classList.contains('checked');
    if(done) { el.classList.remove('checked'); DATA.progState[wKey]=false; }
    else { el.classList.add('checked'); DATA.progState[wKey]=true; }
    window.saveData(); window.genProgram();
}

window.toggleDayCheck = function(dKey, event, sw, bw, dw, r) {
    event.stopPropagation();
    if(DATA.progState[dKey] === true) {
        delete DATA.progState[dKey];
        window.saveData();
        window.genProgram();
    } else {
        window.openProgramLogModal(sw, bw, dw, r, r, r, dKey, event);
    }
}

window.genProgram = function(){
    const container = document.getElementById('schedule-area');
    const s = parseFloat(DATA.inputs.s);
    const b = parseFloat(DATA.inputs.b);
    const d = parseFloat(DATA.inputs.d);
    
    if(!s || !b || !d) {
        container.innerHTML = "<p style='text-align:center; color:#666; margin-top:20px;'>Enter maxes to generate cycle.</p>";
        return;
    }

    const step = 5; // Fixed to LBS
    const bar = 45; // Fixed to LBS
    const rnd=n=>Math.round(n/step)*step;
    
    const s5RM = rnd(s * 0.87); const b5RM = rnd(b * 0.87); const d5RM = rnd(d * 0.87);
    const weeks=[
        {n:1, t:"STRENGTH", m:0.85, s:3, r:5, base:"5RM"},
        {n:2, t:"STRENGTH", m:0.90, s:3, r:5, base:"5RM"},
        {n:3, t:"STRENGTH", m:0.95, s:3, r:5, base:"5RM"},
        {n:4, t:"STRENGTH", m:1.05, s:3, r:5, base:"5RM", l_drop:0.80},
        {n:5, t:"UNLOAD", m:0.85, s:2, r:3, base:"5RM", l_drop:0.85}, 
        {n:6, t:"POWER", m:0.92, s:3, r:3, base:"1RM", l_drop:0.75}, 
        {n:7, t:"POWER", m:0.92, s:3, r:3, base:"1RM", l_drop:0.85}, 
        {n:8, t:"POWER", m:0.95, s:3, r:2, base:"1RM", l_drop:0.70}  
    ];
    
    const calcRamp = (target) => {
        if(target < (bar + 20)) return `${bar}x10, ${rnd((target-bar)*0.6 + bar)}x5`;
        const s2 = rnd((target - bar) * 0.4 + bar); 
        const s3 = rnd((target - bar) * 0.7 + bar);
        const s4 = rnd((target - bar) * 0.85 + bar);
        return `${bar}x12, ${s2}x5, ${s3}x3, ${s4}x1`;
    };

    let h=``;
    weeks.forEach((k, idx)=>{
        const wKey = `w${k.n}`;
        const doneM = DATA.progState[wKey+"_m"] === true;
        const doneW = DATA.progState[wKey+"_w"] === true;
        const doneF = DATA.progState[wKey+"_f"] === true;
        if(doneM && doneW && doneF && !DATA.progState[wKey]) {
            DATA.progState[wKey] = true;
            window.saveData();
        }
        const isWeekDone = DATA.progState[wKey] === true;
        let sH, bH, dH;
        if(k.base === "5RM"){ sH = rnd(s5RM * k.m); bH = rnd(b5RM * k.m); dH = rnd(d5RM * k.m); } 
        else { sH = rnd(s * k.m); bH = rnd(b * k.m); dH = rnd(d * k.m); }
        let l_mult = k.l_drop || 0.85; let m_mult = 0.95;
        const sL = rnd(sH * l_mult); bL = rnd(bH * l_mult); dL = rnd(dH * l_mult);
        const sM = rnd(sH * m_mult); bM = rnd(bH * m_mult); dM = rnd(dH * m_mult);

        const buildDay = (dayName, typeLabel, cls, sw, bw, dw, dKey, isDone) => {
            return `
            <div class="day-row" onclick="window.toggleWarmup(this)">
                <div class="day-title-row">
                    <div class="day-left-grp">
                        <div class="day-check ${isDone?'checked':''}" onclick="window.toggleDayCheck('${dKey}', event, ${sw}, ${bw}, ${dw}, ${k.r})"></div>
                        <span style="font-weight:bold">${dayName}</span>
                    </div>
                    <span class="day-type ${cls}">${typeLabel}</span>
                </div>
                <div class="lift-row"><span class="lift-name">SQ</span> <span class="lift-nums"><span class="calc-trigger" onclick="window.openQuickCalc(${sw}, event)">${sw}</span> (${k.s}x${k.r})</span></div>
                <div class="lift-row"><span class="lift-name">BP</span> <span class="lift-nums"><span class="calc-trigger" onclick="window.openQuickCalc(${bw}, event)">${bw}</span> (${k.s}x${k.r})</span></div>
                <div class="lift-row" style="border:none"><span class="lift-name">DL</span> <span class="lift-nums"><span class="calc-trigger" onclick="window.openQuickCalc(${dw}, event)">${dw}</span> (${k.s}x${k.r})</span></div>
                <div class="warmup-drop">
                    <div class="warmup-header">WARMUP SETS (${bar} LBS)</div>
                    <div class="warmup-line">SQ: ${calcRamp(sw)}</div>
                    <div class="warmup-line">BP: ${calcRamp(bw)}</div>
                    <div class="warmup-line">DL: ${calcRamp(dw)}</div>
                </div>
            </div>`;
        };
        h+=`<div class="week">
            <div class="week-head">
                <span>WEEK ${k.n} <span style="color:#666;font-size:11px">(${k.t})</span></span>
                <div class="chk-box ${isWeekDone?'checked':''}" onclick="window.toggleManualWeek('${wKey}', this, event)"></div>
            </div>
            <div class="week-content ${isWeekDone?'dimmed':''}">
                ${buildDay("MON", `HEAVY (${Math.round(k.m*100)}% ${k.base})`, "type-h", sH, bH, dH, wKey+"_m", doneM)}
                ${buildDay("WED", `LIGHT (${Math.round(l_mult*100)}%)`, "type-l", sL, bL, dL, wKey+"_w", doneW)}
                ${buildDay("FRI", `MEDIUM (${Math.round(m_mult*100)}%)`, "type-m", sM, bM, dM, wKey+"_f", doneF)}
            </div>
        </div>`;
    });
    container.innerHTML=h;
}

// --- GYM SWITCHER ---
window.getCurrentGymData = function(){if(!DATA.gyms[DATA.currentGym])DATA.gyms[DATA.currentGym]={folders:[],library:{}};return DATA.gyms[DATA.currentGym]}
window.showGymManager = function(){document.getElementById('split-manager').classList.add('hidden');document.getElementById('gym-manager').classList.remove('hidden');window.renderGymList()}
window.closeGymManager = function(){document.getElementById('gym-manager').classList.add('hidden');document.getElementById('split-manager').classList.remove('hidden')}
window.renderGymList = function(){const d=document.getElementById('gym-list');d.innerHTML="";Object.keys(DATA.gyms).forEach(g=>{const a=g===DATA.currentGym;d.innerHTML+=`<div class="day-card" onclick="window.selectGym('${g}')"><b>${g}</b>${a?' ‚úî':''} <button class="icon-btn" onclick="window.delGym('${g}', event)">‚úï</button></div>`})}
window.selectGym = function(n){ DATA.currentGym=n; window.saveData(); window.renderDays(); window.closeGymManager(); window.showToast("Switched to "+n); }
window.promptAddGym = function(){window.openInputModal("New Gym","Name",v=>{if(v){DATA.gyms[v]={folders:[],library:{}};window.selectGym(v)}})}
window.delGym = function(n,e){ e.stopPropagation(); if(Object.keys(DATA.gyms).length<=1)return;window.showConfirm("Delete?",()=>{delete DATA.gyms[n];window.selectGym(Object.keys(DATA.gyms)[0])})}

// --- LOG TAB LOGIC ---
let currentFolder = '';
window.renderDays = function(){const g=window.getCurrentGymData();document.getElementById('current-gym-display').innerText=DATA.currentGym;const l=document.getElementById('my-split-list');l.innerHTML="";g.folders.forEach(d=>{const c=(g.library[d]||[]).length;l.innerHTML+=`<div class="day-card"><div style="flex-grow:1;cursor:pointer;" onclick="window.openSession('${d}')"><b>${d}</b><br><span style="font-size:11px;color:#666;">${c} Ex</span></div><div style="display:flex;gap:5px;"><button class="icon-btn" onclick="window.shareFolder('${d}')">‚û¶</button><button class="icon-btn" onclick="window.renameFolder('${d}')">‚úé</button><button class="icon-btn" onclick="window.delFolder('${d}')">‚úï</button></div></div>`})}
window.promptAddDay = function(){window.openInputModal("Folder","Name",v=>{if(v){const g=window.getCurrentGymData();if(!g.folders.includes(v))g.folders.push(v);window.saveData();window.renderDays()}})}
window.openSession = function(d){currentFolder=d;document.getElementById('split-manager').classList.add('hidden');document.getElementById('session-logger').classList.remove('hidden');document.getElementById('session-title').innerText=d;window.renderCart();window.renderShelf()}
window.closeSession = function(){document.getElementById('session-logger').classList.add('hidden');document.getElementById('split-manager').classList.remove('hidden')}
window.clearCart = function(){window.showConfirm("Clear?",()=>{DATA.activeCart=[];DATA.sessionData={};window.saveData();window.renderCart()})}
window.promptNewEx = function(){ document.getElementById('new-ex-name').value=""; window.renderTagGrid(); document.getElementById('modal-new-ex').style.display='flex'; }
window.renderTagGrid = function(){const area = document.getElementById('tag-area'); const defaults = ['Barbell', 'Dumbbell', 'Cable', 'Machine', 'Smith']; const all = [...defaults, ...DATA.customTags]; let h = ''; all.forEach(t => { h += `<div class="chip" onclick="window.appendTag(' (${t})')">${t}</div>`; }); h += `<div class="chip chip-add" onclick="window.promptCustomTag()">+</div>`; area.innerHTML = h;}
window.appendTag = function(t){ document.getElementById('new-ex-name').value += t; }
window.promptCustomTag = function(){ window.openInputModal("Custom Tag", "E.g. Hoist", (val) => { if(val){ window.appendTag(` (${val})`); if(!DATA.customTags.includes(val)){ DATA.customTags.push(val); window.saveData(); window.renderTagGrid(); } } }); }
window.confirmNewEx = function(t){ 
    const v=document.getElementById('new-ex-name').value; 
    if(v){ 
        const g=window.getCurrentGymData(); 
        if(!g.library[currentFolder]) g.library[currentFolder]=[]; 
        g.library[currentFolder].push(v); 
        if(!DATA.exTypes) DATA.exTypes={};
        DATA.exTypes[v]=t; 
        window.saveData(); window.renderShelf(); window.addToCart(v); 
    } 
    document.getElementById('modal-new-ex').style.display='none'; 
}
window.renderShelf = function(){const a=document.getElementById('tile-area');const g=window.getCurrentGymData();const l=g.library[currentFolder]||[]; a.innerHTML=`<button class="tile tile-add" onclick="window.promptNewEx()">+ NEW</button>`; l.forEach(e=>{const cls = isEditing ? 'tile deleting' : 'tile'; const action = isEditing ? `window.deleteLibItem('${e}')` : `window.addToCart('${e}')`; const content = isEditing ? `‚úï ${e}` : e; a.innerHTML+=`<div class="${cls}" onclick="${action}">${content}</div>`;});}
let isEditing = false;
window.toggleEditMode = function(){ isEditing = !isEditing; document.getElementById('edit-lib-btn').innerText = isEditing ? 'DONE' : '‚úé EDIT'; window.renderShelf(); }
window.deleteLibItem = function(e){ window.showConfirm(`Delete "${e}"?`, () => { const g=window.getCurrentGymData(); g.library[currentFolder] = g.library[currentFolder].filter(x => x !== e); window.saveData(); window.renderShelf(); }); }
window.addToCart = function(e){if(!DATA.activeCart.includes(e)){DATA.activeCart.push(e);if(!DATA.sessionData[e])DATA.sessionData[e]=[{w:'',r:''}];window.saveData();window.renderCart()}}
window.removeExFromCart = function(e){DATA.activeCart=DATA.activeCart.filter(x=>x!==e);delete DATA.sessionData[e];window.saveData();window.renderCart()}

// HELPER: Get Best Lift (FIXED: RETURNS WEIGHT x REPS)
window.getBestLift = function(exName) {
    const logs = DATA.history.filter(l => l.ex === exName);
    if(logs.length === 0) return null;
    const isC = DATA.exTypes[exName] === 'cardio';
    
    if(isC) {
        let bestLog = logs[0]; let bestPace = 9999;
        logs.forEach(l => {
            const time = parseFloat(l.w); const dist = parseFloat(l.r);
            if(time && dist) { const pace = time / dist; if(pace < bestPace) { bestPace = pace; bestLog = l; } }
        });
        if(bestPace === 9999) return null;
        return `${bestPace.toFixed(2)}/mi`;
    } else {
        logs.sort((a,b) => b.rm - a.rm);
        const best = logs[0];
        return `${best.w} LBS x ${best.r} REPS`;
    }
}

// RENDER CART - FIXED CALCULATOR BUTTON
window.renderCart = function(){
    const area=document.getElementById('active-workout-area'); area.innerHTML=""; 
    if(DATA.activeCart.length===0){ area.innerHTML="<div style='text-align:center;padding:30px;color:#555;'>Empty Workout</div>"; return; } 
    
    DATA.activeCart.forEach((ex, exIdx)=>{ 
        const isC=DATA.exTypes[ex]==='cardio'; const sets=DATA.sessionData[ex]||[];
        const isLR=DATA.sessionData[ex+'_LR']===true; 
        const best = window.getBestLift(ex);
        let histHTML = best ? `<div class="hist-badge">BEST: ${best}</div>` : '';
        let h=`<div class="ex-card"><div class="ex-top"><div class="ex-name">${ex}<div class="ex-hist">${histHTML}</div></div><div class="ex-tools">${!isC?`<div class="toggle-lr ${isLR?'active':''}" onclick="window.toggleLR('${ex}')">L+R</div>`:''}<button onclick="window.removeExFromCart('${ex}')" style="background:none;border:none;color:#555;">‚úï</button></div></div>`; 
        let r=""; 
        
        if(isC){ 
            sets.forEach((s,i)=>{ r+=`<div class="cardio-row"><span class="set-num">${i+1}</span><div class="input-wrapper"><input type="text" inputmode="decimal" value="${s.w}" placeholder="MIN" onchange="window.updateSet('${ex}',${i},'w',this.value)"></div><div class="input-wrapper"><input type="text" inputmode="decimal" value="${s.r}" placeholder="MI" onchange="window.updateSet('${ex}',${i},'r',this.value)"></div><div class="input-wrapper"><input type="text" inputmode="decimal" value="${s.hr||''}" placeholder="HR" onchange="window.updateSet('${ex}',${i},'hr',this.value)"></div><button class="del-btn" onclick="window.removeSet('${ex}',${i})">‚úï</button></div>` }); 
        } else { 
            let i=0;
            while(i < sets.length) {
                let s = sets[i]; let ns = sets[i+1];
                const safeEx = ex.replace(/'/g, "\\'");
                
                const row = (idx, st, lab) => `
                    <div class="set-row">
                        <div class="set-num">${lab}</div>
                        <div class="input-wrapper"><input type="text" inputmode="decimal" value="${st.w}" onchange="window.updateSet('${safeEx}',${idx},'w',this.value)"><span class="input-unit">LBS</span></div>
                        <button class="calc-btn" onclick="window.launchCalc(${exIdx},${idx}, event)">üßÆ</button>
                        <div class="input-wrapper"><input type="text" inputmode="decimal" value="${st.r}" onchange="window.updateSet('${safeEx}',${idx},'r',this.value)"><span class="input-unit">REPS</span></div>
                        <button class="menu-btn" onclick="window.openSetOpt('${safeEx}',${idx})">...</button>
                        <button class="del-btn" onclick="window.removeSet('${safeEx}',${idx})">‚úï</button>
                    </div>`;
                
                if(s.type === 'drop_parent' && ns && ns.type === 'drop_child') {
                    r += `<div class="set-group-box set-group-drop">${row(i,s,i+1)}${row(i+1,ns,'<span class="label-drop">DROP</span>')}</div>`; i += 2;
                } else if(s.type === 'super_parent' && ns && ns.type === 'super_child') {
                    r += `<div class="set-group-box set-group-super">${row(i,s,i+1)}${row(i+1,ns,'<span class="label-super">SUPER</span>')}</div>`; i += 2;
                } else if(s.type === 'assist_parent' && ns && ns.type === 'assist_child') {
                    r += `<div class="set-group-box set-group-assist">${row(i,s,i+1)}${row(i+1,ns,'<span class="label-assist">ASST</span>')}</div>`; i += 2;
                } else {
                    r += row(i,s,i+1); i++;
                }
            }
        } 
        area.innerHTML+=`${h}<div id="sets-${ex}">${r}</div><button class="btn btn-sec btn-sm" onclick="window.addSet('${ex}')">+ ADD SET</button></div>` 
    }); 
}

window.addSet = function(e){if(!DATA.sessionData[e])DATA.sessionData[e]=[]; if(DATA.sessionData[e+'_LR']===true){DATA.sessionData[e].push({w:'',r:'',side:'L'});DATA.sessionData[e].push({w:'',r:'',side:'R'})}else{DATA.sessionData[e].push({w:'',r:''})} window.saveData();window.renderCart()}
window.removeSet = function(e,i){DATA.sessionData[e].splice(i,1);window.saveData();window.renderCart()}
window.updateSet = function(e,i,f,v){if(!DATA.sessionData[e][i])return;DATA.sessionData[e][i][f]=v;window.saveData()}
window.toggleLR = function(e){ const c=DATA.sessionData[e+'_LR']===true; DATA.sessionData[e+'_LR']=!c; window.saveData(); window.renderCart(); }
window.finishSession = function(){const t=new Date().toISOString().split('T')[0]; DATA.activeCart.forEach(e=>{ const sets=DATA.sessionData[e]; const isC=DATA.exTypes[e]==='cardio'; sets.forEach(s=>{ if(s.w && s.r){ if(isC) DATA.history.push({date:t, ex:e, w:s.w, r:s.r, hr:s.hr, type:'cardio'}); else DATA.history.push({date:t, ex:e, w:s.w, r:s.r, rm:Math.round(s.w*(1+0.033*s.r)), type:s.type||''}); } }); }); window.clearCart(); window.closeSession(); window.showToast("Saved!"); }

// --- SET OPTIONS ---
let optTarget = null;
window.openSetOpt = function(ex, i) { optTarget = {ex, i}; document.getElementById('modal-set-opt').style.display = 'flex'; }
window.applySetType = function(type) {
    if(optTarget) {
        const {ex, i} = optTarget; const s = DATA.sessionData[ex][i]; s.type = type + '_parent';
        let nw = s.w; if(type === 'drop') nw = ""; 
        const ns = {w: nw, r: '', type: type + '_child'};
        DATA.sessionData[ex].splice(i+1, 0, ns); window.saveData(); window.renderCart();
    } document.getElementById('modal-set-opt').style.display = 'none';
}

// --- CALC ---
let calcTarget = null; let calcSide=0, calcBar=45, calcMode='bar';
window.openQuickCalc = function(weight, event) {
    if(event) event.stopPropagation();
    calcTarget = null; // No target, just visual
    window.setCalcMode('bar');
    document.getElementById('calc-total').value = weight;
    window.manualCalcUpdate(weight);
    document.getElementById('modal-plate-calc').style.display='flex';
}

// FIXED LAUNCH FUNCTION WITH SAFEGUARDS
window.launchCalc = function(exIdx, setIdx, event) { 
    if(event) event.stopPropagation();
    const exName = DATA.activeCart[exIdx];
    
    // SAFETY CHECK: If array is messed up, abort to prevent crash
    if (!DATA.sessionData[exName] || !DATA.sessionData[exName][setIdx]) {
        console.warn("Set data missing for calc launch");
        return;
    }

    calcTarget = {ex: exName, idx: setIdx}; 
    const currentVal = DATA.sessionData[exName][setIdx].w || 45; 
    
    window.setCalcMode('bar'); 
    document.getElementById('calc-total').value = currentVal; 
    window.manualCalcUpdate(currentVal); 
    window.renderPlateButtons(); 
    document.getElementById('modal-plate-calc').style.display='flex'; 
}

window.closeCalc = function(){ document.getElementById('modal-plate-calc').style.display='none'; }
window.renderPlateButtons = function(){ const grid = document.getElementById('plate-btn-grid'); grid.innerHTML = ""; [45,35,25,10,5,2.5].forEach(w => { grid.innerHTML += `<button class="p-btn" onclick="window.addPlate(${w})">${w}</button>`; }); }
window.setCalcMode = function(m){ calcMode=m; const stdBar = 45; calcBar=(m==='bar')?stdBar:0; document.getElementById('mode-bar').style.background=(m==='bar')?'var(--success)':'#333'; document.getElementById('mode-bar').style.color=(m==='bar')?'black':'white'; document.getElementById('mode-single').style.background=(m==='single')?'var(--success)':'#333'; document.getElementById('mode-single').style.color=(m==='single')?'black':'white'; window.updateCalcDisplay(); }
window.addPlate = function(w){ calcSide+=w; window.updateCalcDisplay(); }
window.resetCalc = function(){ calcSide=0; window.updateCalcDisplay(); }
window.updateCalcDisplay = function(){ let t=0; if(calcMode==='bar') t=(calcSide*2)+calcBar; else t=calcSide; document.getElementById('calc-total').value = t; window.renderPlateViz(calcSide); }
window.manualCalcUpdate = function(v){ const n=parseFloat(v); if(!isNaN(n)){ if(calcMode==='bar') calcSide=(n-calcBar)/2; else calcSide=n; window.renderPlateViz(calcSide); } }
window.applyCalc = function(){ if(calcTarget){ const val = document.getElementById('calc-total').value; if(DATA.sessionData[calcTarget.ex] && DATA.sessionData[calcTarget.ex][calcTarget.idx]){ DATA.sessionData[calcTarget.ex][calcTarget.idx].w = val; window.saveData(); window.renderCart(); } } window.closeCalc(); }
window.useBW = function(){ if(calcTarget){ DATA.sessionData[calcTarget.ex][calcTarget.idx].w = "BW"; window.saveData(); window.renderCart(); } window.closeCalc(); }
window.renderPlateViz = function(weight){ const viz = document.getElementById('plate-stack-display'); viz.innerHTML = ""; let rem = weight; const plates = [{w:45, c:'vp-45', t:'45'}, {w:35, c:'vp-35', t:'35'}, {w:25, c:'vp-25', t:'25'}, {w:10, c:'vp-10', t:'10'}, {w:5, c:'vp-5', t:'5'}, {w:2.5, c:'vp-2_5', t:'2.5'}]; plates.forEach(p => { while(rem >= p.w - 0.01){ viz.innerHTML += `<div class="viz-plate ${p.c}">${p.t}</div>`; rem -= p.w; } }); }

// --- STATS ---
window.openStatsPicker = function(){
    const modal = document.getElementById('modal-stats-picker'); const content = document.getElementById('picker-content'); content.innerHTML = '';
    const gym = DATA.gyms[DATA.currentGym];
    if(gym.folders.length > 0){ content.innerHTML += `<div class="picker-section"><div class="picker-label">Muscle Groups</div>`; gym.folders.forEach(f => { content.innerHTML += `<div class="picker-item" onclick="window.selectStatsTarget('folder', '${f}')"><span>üìÅ ${f}</span><span class="folder-tag">GROUP</span></div>`; }); content.innerHTML += `</div>`; }
    const allEx = [...new Set(DATA.history.map(l => l.ex))].sort();
    content.innerHTML += `<div class="picker-section"><div class="picker-label">Exercises</div>`; allEx.forEach(e => { content.innerHTML += `<div class="picker-item" onclick="window.selectStatsTarget('exercise', '${e}')"><span>${e}</span></div>`; }); content.innerHTML += `</div>`; modal.style.display = 'block';
}
window.renderPickerItems = function(query){ const q = query.toLowerCase(); document.querySelectorAll('.picker-item').forEach(item => { const text = item.innerText.toLowerCase(); item.style.display = text.includes(q) ? 'flex' : 'none'; }); }
window.selectStatsTarget = function(mode, target){ statsMode = mode; statsTarget = target; document.getElementById('stats-current-label').innerText = target; document.getElementById('modal-stats-picker').style.display = 'none'; window.renderGraph(); }
window.renderGraph = function(){
    const ctx = document.getElementById('perfChart').getContext('2d'); const det = document.getElementById('stat-details'); if(window.myChart) window.myChart.destroy();
    let datasets = []; let allLabels = new Set();
    try {
        if(statsMode === 'exercise'){
            const logs = DATA.history.filter(l => l.ex === statsTarget && l.type!=='cardio').sort((a,b) => new Date(a.date) - new Date(b.date));
            if(logs.length === 0) { det.innerText="No Strength Data"; return; }
            const dataPoints = logs.map(l => ({x: l.date, y: l.rm})); logs.forEach(l => allLabels.add(l.date));
            datasets.push({ label: statsTarget, data: dataPoints, borderColor: '#2ed573', backgroundColor: 'rgba(46, 213, 115, 0.1)', borderWidth: 2, pointRadius: 3, tension: 0.3 });
            det.innerText = `BEST 1RM: ${Math.max(...logs.map(l=>l.rm))} LBS`;
        } else {
            const gym = DATA.gyms[DATA.currentGym]; const exercises = gym.library[statsTarget] || []; const colors = ['#ff4757', '#2ed573', '#ffa502', '#a29bfe', '#00d2d3'];
            exercises.forEach((ex, idx) => { const logs = DATA.history.filter(l => l.ex === ex && l.type!=='cardio').sort((a,b) => new Date(a.date) - new Date(b.date)); if(logs.length > 0){ logs.forEach(l => allLabels.add(l.date)); datasets.push({ label: ex, data: logs.map(l => ({x: l.date, y: l.rm})), borderColor: colors[idx % colors.length], borderWidth: 2, pointRadius: 0, tension: 0.3, fill: false }); } });
            det.innerText = `${datasets.length} Exercises in Group`;
        }
        if(datasets.length === 0) { det.innerText="No Data"; return; }
        const sortedLabels = Array.from(allLabels).sort();
        window.myChart = new Chart(ctx, { type: 'line', data: { labels: sortedLabels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels: { color:'#888', boxWidth:10, font:{size:10} } } }, scales: { x: { grid:{color:'#333'}, ticks:{color:'#666'} }, y: { grid:{color:'#333'}, ticks:{color:'#666'} } } } });
    } catch(err) { console.error(err); det.innerText = "Error loading graph."; }
}

// --- UTILS ---
window.showToast = function(m){const t=document.getElementById('toast');t.innerText=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
window.openInputModal = function(t,p,c){const m=document.getElementById('modal-input-overlay'),i=document.getElementById('modal-input'),b=document.getElementById('modal-ok');document.getElementById('modal-title').innerText=t;i.value="";i.placeholder=p;m.style.display='flex';i.focus();const n=b.cloneNode(true);b.parentNode.replaceChild(n,b);n.addEventListener('click',()=>{m.style.display='none';c(i.value)})}
window.closeInputModal = function(){document.getElementById('modal-input-overlay').style.display='none'}
window.showConfirm = function(m,c){const d=document.getElementById('modal-confirm-overlay'),b=document.getElementById('confirm-ok');document.getElementById('confirm-desc').innerText=m;d.style.display='flex';const n=b.cloneNode(true);b.parentNode.replaceChild(n,b);n.addEventListener('click',()=>{d.style.display='none';c()})}
window.closeConfirmModal = function(){document.getElementById('modal-confirm-overlay').style.display='none'}
window.copyShareCode = function(){navigator.clipboard.writeText(window.shareCode).then(()=>window.showToast("Copied!"))}
window.shareFolder = function(n){const g=window.getCurrentGymData(),d={name:n,exs:g.library[n]||[]},s=btoa(JSON.stringify(d)),l=window.location.origin+window.location.pathname+"?import="+s;document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById("qrcode"),{text:l,width:128,height:128});window.shareCode=s;document.getElementById('modal-share').style.display='flex'}
window.exportCSV = function(){if(DATA.history.length===0){window.showToast("No Data");return}let c="Date,Exercise,Weight,Reps,1RM,HR\n";DATA.history.forEach(l=>{c+=`${l.date},${l.ex},${l.w},${l.r},${l.rm||0},${l.hr||''}\n`;});const b=new Blob([c],{type:'text/csv'});const a=document.createElement('a');a.href=window.URL.createObjectURL(b);a.download="netgains_data.csv";a.click()}
window.openManualImport = function(){document.getElementById('modal-manual-import').style.display='flex'}
window.runManualImport = function(){const r=document.getElementById('import-area').value;if(!r)return;try{const d=JSON.parse(atob(r)),g=window.getCurrentGymData();if(!g.folders.includes(d.name))g.folders.push(d.name);g.library[d.name]=d.exs;window.saveData();window.renderDays();document.getElementById('modal-manual-import').style.display='none';window.showToast("Imported!")}catch(e){window.showToast("Invalid")}}
window.renameFolder = function(o){window.openInputModal("Rename",o,v=>{if(v&&v!==o){const g=window.getCurrentGymData(),i=g.folders.indexOf(o);if(i!==-1)g.folders[i]=v;if(g.library[o]){g.library[v]=g.library[o];delete g.library[o]}window.saveData();window.renderDays()}})}
window.delFolder = function(n){window.showConfirm("Delete?",()=>{const g=window.getCurrentGymData();g.folders=g.folders.filter(d=>d!==n);delete g.library[n];window.saveData();window.renderDays()})}

// START
initUI();
</script>
</body>
</html>
