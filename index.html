<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>NetGains AI</title>
<style>
  /* --- 1. VARIABLES & RESET --- */
  :root { --bg: #0f0f13; --card: #1a1a24; --text: #ffffff; --accent: #ff4757; --success: #2ed573; --dim: #888; --input-bg: #121212; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; padding: 0; background-color: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; overflow-x: hidden; padding-bottom: 90px; }

  /* --- 2. UTILS --- */
  .hidden { display: none !important; }
  .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 13px; margin-top: 10px; transition: 0.1s; }
  .btn:active { transform: scale(0.98); }
  .btn-main { background: linear-gradient(135deg, #ff4757, #ff6b81); color: white; }
  .btn-sec { background: #333; color: white; border: 1px solid #444; }
  .btn-danger { background: #2a1a1a; color: #ff4757; border: 1px solid #522; font-size: 11px; padding: 10px; }
  .btn-ghost { background: transparent; border: 1px dashed #444; color: #666; font-size: 10px; padding: 6px 10px; width: auto; display: inline-block; cursor: pointer; }
  .btn-sm { padding: 8px; font-size: 11px; width: auto; display: inline-block; margin: 0; }
  
  h1 { text-align: center; margin: 25px 0 5px; font-size: 26px; letter-spacing: -1px; font-weight: 900; color: white; }
  .brand-span { color: var(--accent); }
  .sub { text-align: center; color: var(--dim); font-size: 11px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 25px; }
  
  /* INPUTS */
  input { background: var(--input-bg); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; font-size: 16px; margin-bottom: 5px; }
  input:focus { outline:none; border-color: var(--accent); }
  
  /* --- 3. LAYOUT --- */
  .view { padding: 20px; max-width: 600px; margin: 0 auto; animation: fade 0.3s; }
  @keyframes fade { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

  /* --- 4. PROGRAM STYLES --- */
  .week { background: var(--card); border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; overflow: hidden; }
  .week-head { display: flex; justify-content: space-between; padding: 15px; background: #222; border-bottom: 1px solid #333; font-weight: bold; }
  .day-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #222; align-items: center; cursor: pointer; }
  .tag { font-size: 9px; padding: 3px 6px; border-radius: 4px; color: black; font-weight: 800; margin-left: 8px; text-transform: uppercase; }
  .tag-h { background: #ff4757; } .tag-l { background: #2ed573; } .tag-m { background: #ffa502; }
  .chk { width: 22px; height: 22px; border: 2px solid #555; border-radius: 50%; margin-right: 12px; display: inline-block; }
  .completed .chk { background: var(--success); border-color: var(--success); }
  .completed { text-decoration: line-through; opacity: 0.5; color: var(--success); }
  .warmup-box { background: #151515; border-top: 1px solid #333; padding: 10px 15px; display: none; }
  .wu-row { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 5px; }
  .wu-title { color: #ffa502; font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 8px; display: block; }
  .arrow-icon { color: #666; font-size: 10px; margin-left: 8px; transition: 0.2s; }
  .open .arrow-icon { transform: rotate(180deg); color: var(--accent); }

  /* --- 5. LOG STYLES --- */
  /* GYM SELECTOR */
  .gym-selector { background: #222; border: 1px solid #333; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; cursor: pointer; }
  .gym-label { font-size: 10px; color: #888; text-transform: uppercase; }
  .gym-name { font-weight: bold; font-size: 14px; color: var(--accent); }

  .day-card { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #333; }
  .icon-btn { background: #222; border: 1px solid #444; color: #ccc; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }
  
  #active-workout-area { min-height: 100px; margin-bottom: 30px; }
  .ex-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; position: relative; animation: slideIn 0.2s ease; }
  @keyframes slideIn { from{transform:translateX(-10px);opacity:0} to{transform:translateX(0);opacity:1} }
  .ex-top { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
  .ex-name { font-weight: bold; font-size: 16px; }
  .ex-hist-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .ex-hist { font-size: 11px; color: var(--success); font-weight: bold; }
  .hist-btn { background: none; border: 1px solid #333; color: #888; border-radius: 4px; padding: 2px 6px; font-size: 12px; cursor: pointer; }
  .history-dropdown { background: #111; margin: 0 -15px 15px -15px; padding: 10px 15px; border-top: 1px solid #333; border-bottom: 1px solid #333; display: none; }
  .hist-row { display: flex; justify-content: space-between; font-size: 11px; color: #ccc; margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 4px; }

  /* SET ROWS WITH CALCULATOR */
  .set-row { display: grid; grid-template-columns: 30px 1fr 40px 1fr 30px; gap: 5px; align-items: center; margin-bottom: 8px; }
  .set-num { color: #666; font-size: 12px; font-weight: bold; text-align: center; }
  .del-set { color: #555; background: none; border: none; font-size: 16px; cursor: pointer; }
  .del-set:active { color: red; }
  .calc-btn { background: #222; border: 1px solid #444; color: var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; height: 42px; }

  .shelf-title { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; border-top: 1px solid #333; padding-top: 20px; }
  .tile-grid { display: flex; flex-wrap: wrap; gap: 8px; }
  .tile { background: #222; border: 1px solid #444; color: #ccc; padding: 8px 12px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 500; transition: 0.1s; }
  .tile:active { background: var(--accent); color: black; border-color: var(--accent); }
  .tile-add { border-style: dashed; color: #666; }

  /* --- 6. MODALS --- */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .modal-box { background: #1e1e1e; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  .modal-title { margin-top: 0; color: white; font-size: 18px; margin-bottom: 10px; }
  .modal-desc { color: #888; font-size: 13px; margin-bottom: 20px; }
  
  #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid #333; color: white; padding: 12px 24px; border-radius: 30px; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 3000; }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
  .toast-icon { color: var(--success); }

  /* PLATE CALC MODAL SPECIFIC */
  .plate-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
  .p-btn { background: #222; border: 1px solid #444; color: white; padding: 15px 0; border-radius: 8px; font-weight: bold; cursor: pointer; }
  .p-btn:active { background: var(--accent); border-color: var(--accent); }
  .calc-display { text-align: center; font-size: 24px; font-weight: bold; color: var(--success); margin-bottom: 15px; padding: 10px; background: #111; border-radius: 8px; }
  .bar-toggle { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 12px; color: #aaa; background: #222; padding: 8px 12px; border-radius: 6px; }

  /* PWA MODAL */
  .pwa-step { margin-bottom: 10px; font-size: 13px; color: #ccc; display: flex; align-items: center; gap: 10px; }
  .pwa-icon { font-size: 18px; }

  /* --- 7. NAV --- */
  .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: #181818; border-top: 1px solid #333; display: grid; grid-template-columns: 1fr 1fr 1fr; z-index: 1000; padding-bottom: 20px; }
  .nav-btn { background: none; border: none; color: #666; font-size: 10px; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
  .nav-btn.active { color: var(--accent); }
  .nav-icon { font-size: 22px; margin-bottom: 5px; }

</style>
</head>
<body>

<div id="modal-pwa" class="modal-overlay">
  <div class="modal-box" style="border: 1px solid var(--accent);">
    <h3 class="modal-title" style="color:var(--accent)">‚ö† DATA RISK</h3>
    <p class="modal-desc" style="color:#fff">If you run this in a browser tab, your data <b>will be deleted</b> when your phone clears cache.</p>
    <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:20px;">
        <div class="pwa-step"><span class="pwa-icon">1Ô∏è‚É£</span> Tap "Share" or "Menu"</div>
        <div class="pwa-step"><span class="pwa-icon">2Ô∏è‚É£</span> Scroll down</div>
        <div class="pwa-step"><span class="pwa-icon">3Ô∏è‚É£</span> Tap "Add to Home Screen"</div>
    </div>
    <button class="btn btn-sec" onclick="document.getElementById('modal-pwa').style.display='none'">I UNDERSTAND THE RISK</button>
  </div>
</div>

<div id="modal-input-overlay" class="modal-overlay">
  <div class="modal-box">
    <h3 id="modal-title" class="modal-title">Input</h3>
    <input type="text" id="modal-input" placeholder="...">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
      <button class="btn btn-sec" onclick="closeInputModal()" style="margin:0">CANCEL</button>
      <button class="btn btn-main" id="modal-ok" style="margin:0">SAVE</button>
    </div>
  </div>
</div>

<div id="modal-plate-calc" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title">Plate Math</h3>
    <div class="calc-display" id="calc-total">45 lbs</div>
    
    <div class="bar-toggle" onclick="toggleBar()">
        <span>Bar Weight (45lbs)</span>
        <span id="bar-status" style="color:var(--success); font-weight:bold;">ON</span>
    </div>

    <div class="plate-grid">
        <button class="p-btn" onclick="addPlate(45)">45</button>
        <button class="p-btn" onclick="addPlate(35)">35</button>
        <button class="p-btn" onclick="addPlate(25)">25</button>
        <button class="p-btn" onclick="addPlate(10)">10</button>
        <button class="p-btn" onclick="addPlate(5)">5</button>
        <button class="p-btn" onclick="addPlate(2.5)">2.5</button>
    </div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn btn-sec" onclick="resetCalc()" style="margin:0; background:#3a1a1a; color:#ff4757;">RESET</button>
      <button class="btn btn-main" onclick="applyCalc()" style="margin:0">USE WEIGHT</button>
    </div>
  </div>
</div>

<div id="modal-confirm-overlay" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title">Confirm</h3>
    <p id="confirm-desc" class="modal-desc">Are you sure?</p>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn btn-sec" onclick="closeConfirmModal()" style="margin:0">CANCEL</button>
      <button class="btn btn-main" id="confirm-ok" style="margin:0; background: #333; border: 1px solid #555;">YES</button>
    </div>
  </div>
</div>

<div id="toast"><span class="toast-icon">‚úì</span> <span id="toast-msg">Saved</span></div>

<div id="view-program" class="view">
  <h1>NETGAINS <span class="brand-span">AI</span></h1>
  <p class="sub">ENGINE</p>
  <div style="background:#222; padding:15px; border-radius:12px; border:1px solid #333; margin-bottom:20px;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <input type="number" id="w" placeholder="Weight (lbs)">
        <input type="number" id="r" placeholder="Reps">
    </div>
    <button class="btn btn-main" onclick="genProgram()">Generate 8-Week Cycle</button>
  </div>
  <div id="schedule-area"></div>
</div>

<div id="view-log" class="view hidden">
  <h1>TRAINING LOG</h1>
  <p class="sub">TRACKER</p>

  <div class="gym-selector" onclick="toggleGymSelect()">
      <div>
        <div class="gym-label">CURRENT LOCATION</div>
        <div class="gym-name" id="current-gym-display">Main Gym</div>
      </div>
      <div style="color:#666">‚ñº</div>
  </div>

  <div id="split-manager">
      <div id="my-split-list"></div>
      
      <button class="btn btn-sec" style="border-style:dashed; color:#888;" onclick="promptAddDay()">+ NEW FOLDER</button>
      
      <div id="preset-area" style="margin-top:40px; border-top:1px solid #333; padding-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="color:#555; font-size:10px;">PRESETS</span>
            <span onclick="hidePresets()" style="color:#ff4757; font-size:10px; cursor:pointer;">HIDE FOREVER</span>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
           <button class="btn btn-sec" style="margin:0; font-size:10px;" onclick="loadPreset('PPL')">LOAD PPL</button>
           <button class="btn btn-sec" style="margin:0; font-size:10px;" onclick="loadPreset('UL')">LOAD UPPER/LOWER</button>
        </div>
      </div>
  </div>

  <div id="session-logger" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; align-items:center;">
            <button class="btn btn-sec" onclick="closeSession()" style="width:auto; margin:0; padding:10px 15px;">‚Üê</button>
            <h2 id="session-title" style="margin:0 0 0 15px; color:var(--accent); font-size:20px;"></h2>
        </div>
        <button class="btn-ghost" onclick="clearCart()">START FRESH</button>
      </div>
      
      <div id="active-workout-area"></div>

      <button class="btn btn-main" onclick="finishSession()">FINISH & SAVE LOG</button>

      <div class="shelf-title">EXERCISE LIBRARY (TAP TO ADD)</div>
      <div id="tile-area" class="tile-grid"></div>
  </div>
</div>

<div id="view-tools" class="view hidden">
  <h1>TOOLS</h1>
  <p class="sub">UTILITIES</p>
  
  <div class="tool-box">
      <h3 style="margin:0 0 15px 0; color:var(--accent)">DATA MANAGEMENT</h3>
      <p style="font-size:11px; color:#888; margin-bottom:15px;">Download your entire set-by-set history for Excel.</p>
      <button class="btn btn-sec" onclick="exportCSV()">DOWNLOAD HISTORY (.CSV)</button>
  </div>

  <div class="tool-box">
      <h3 style="margin:0 0 15px 0; color:var(--accent)">REST TIMER</h3>
      <div class="timer-display" id="t-disp">00:00</div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
          <button class="btn btn-sec" onclick="startTimer(90)">90s</button>
          <button class="btn btn-sec" onclick="startTimer(180)">3m</button>
          <button class="btn btn-sec" onclick="startTimer(300)">5m</button>
      </div>
      <button class="btn btn-main" style="margin-top:10px; background:#333;" onclick="clearInterval(timer);document.getElementById('t-disp').innerText='00:00'">STOP</button>
  </div>
  
  <div class="tool-box" style="border-color:#444;">
      <button class="btn btn-danger" onclick="nuke()">FACTORY RESET APP</button>
  </div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="switchTab('program', this)"><span class="nav-icon">üìä</span> PROGRAM</button>
    <button class="nav-btn" onclick="switchTab('log', this)"><span class="nav-icon">üìù</span> LOG</button>
    <button class="nav-btn" onclick="switchTab('tools', this)"><span class="nav-icon">‚öí</span> TOOLS</button>
</div>

<script>
// --- MIGRATION & INIT ---
// New Data Structure: { gyms: { "GymName": { folders: [], library: {} } }, currentGym: "Main Gym" }
let appData = JSON.parse(localStorage.getItem('netGainsData') || 'null');

// MIGRATION SCRIPT (Runs once)
if (!appData) {
    const oldDays = JSON.parse(localStorage.getItem('myDays') || '[]');
    const oldLib = JSON.parse(localStorage.getItem('myLibrary') || '{}');
    appData = {
        currentGym: 'Main Gym',
        gyms: {
            'Main Gym': { folders: oldDays, library: oldLib }
        }
    };
    localStorage.setItem('netGainsData', JSON.stringify(appData));
}

let activeCart = JSON.parse(localStorage.getItem('activeCart') || '[]'); 
let sessionData = JSON.parse(localStorage.getItem('sessionData') || '{}'); 
let history = JSON.parse(localStorage.getItem('liftHistory') || '{}'); 
let globalLog = JSON.parse(localStorage.getItem('globalLog') || '[]'); 
let showPresets = localStorage.getItem('hidePresets') !== 'true';

// PWA CHECK
if (!window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) {
    // Only show if not installed
    if (!sessionStorage.getItem('pwaDismissed')) {
        document.getElementById('modal-pwa').style.display = 'flex';
        sessionStorage.setItem('pwaDismissed', 'true');
    }
}

renderDays();
if(!showPresets) document.getElementById('preset-area').style.display = 'none';

// --- NAV ---
function switchTab(id, btn) {
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    document.getElementById('view-'+id).classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// --- GYM LOGIC ---
function getCurrentGymData() {
    if(!appData.gyms[appData.currentGym]) {
        appData.gyms[appData.currentGym] = { folders: [], library: {} };
    }
    return appData.gyms[appData.currentGym];
}

function toggleGymSelect() {
    // Simple way: Input modal to switch/add
    openInputModal("Switch/Add Gym", "Enter Gym Name (e.g. Home)", (val) => {
        if(val) {
            appData.currentGym = val;
            if(!appData.gyms[val]) appData.gyms[val] = { folders: [], library: {} };
            saveAppData();
            renderDays();
            showToast("Switched to " + val);
        }
    });
}

function renderDays() {
    const gymData = getCurrentGymData();
    document.getElementById('current-gym-display').innerText = appData.currentGym;
    
    const list = document.getElementById('my-split-list');
    list.innerHTML = "";
    
    if(gymData.folders.length === 0) list.innerHTML = "<div style='text-align:center; color:#555; margin:30px 0;'>No folders in this gym.</div>";
    
    gymData.folders.forEach((day) => {
        const count = (gymData.library[day]||[]).length;
        list.innerHTML += `
        <div class="day-card">
            <div style="flex-grow:1; cursor:pointer;" onclick="openSession('${day}')">
                <b>${day}</b><br><span style="font-size:11px; color:#666;">${count} Saved Exercises</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="icon-btn" onclick="renameFolder('${day}')">‚úé</button>
                <button class="icon-btn" style="color:#ff4757; border-color:#522;" onclick="delFolder('${day}')">‚úï</button>
            </div>
        </div>`;
    });
}

// --- SESSION LOGIC ---
let currentFolder = "";

function openSession(day) {
    currentFolder = day;
    document.getElementById('split-manager').classList.add('hidden');
    document.getElementById('session-logger').classList.remove('hidden');
    document.getElementById('session-title').innerText = day;
    renderCart();
    renderShelf();
}

function closeSession() {
    document.getElementById('session-logger').classList.add('hidden');
    document.getElementById('split-manager').classList.remove('hidden');
}

function clearCart() {
    showConfirm("Start fresh? Clears current workout.", () => {
        activeCart = [];
        sessionData = {};
        saveSession();
        renderCart();
        showToast("Session Cleared");
    });
}

function renderCart() {
    const area = document.getElementById('active-workout-area');
    area.innerHTML = "";
    if(activeCart.length === 0) {
        area.innerHTML = "<div style='text-align:center; color:#444; padding:30px; border:1px dashed #333; border-radius:10px;'>Active Workout Empty<br><span style='font-size:11px'>Tap tiles below to add</span></div>";
        return;
    }
    
    activeCart.forEach((ex) => {
        const last = history[ex] || "No history";
        const sets = sessionData[ex] || [];
        
        let setsHtml = "";
        sets.forEach((set, idx) => {
            // New: Input ID for calculator targeting
            const inputId = `w-${ex}-${idx}`;
            setsHtml += `
            <div class="set-row">
                <span class="set-num">${idx+1}</span>
                <input type="number" id="${inputId}" placeholder="Lbs" value="${set.w}" onchange="updateSet('${ex}', ${idx}, 'w', this.value)">
                <button class="calc-btn" onclick="openCalc('${inputId}')">üßÆ</button>
                <input type="number" placeholder="Reps" value="${set.r}" onchange="updateSet('${ex}', ${idx}, 'r', this.value)">
                <button class="del-set" onclick="removeSet('${ex}', ${idx})">‚úï</button>
            </div>`;
        });

        // History list logic
        const histRows = globalLog.filter(l => l.ex === ex).sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
        let histHtml = "";
        if(histRows.length > 0) {
            histRows.forEach(h => {
                histHtml += `<div class="hist-row"><span class="hist-date">${h.date}</span><span>${h.w} x ${h.r}</span></div>`;
            });
        } else {
            histHtml = "<div style='text-align:center; color:#555; font-size:10px;'>No recorded history</div>";
        }

        area.innerHTML += `
        <div class="ex-card">
            <div class="ex-top">
                <span class="ex-name">${ex}</span>
                <button onclick="removeExFromCart('${ex}')" style="background:none; border:none; color:#555; cursor:pointer;">REMOVE</button>
            </div>
            <div class="ex-hist-line">
                <span class="ex-hist">BEST: ${last}</span>
                <button class="hist-btn" onclick="toggleHist('${ex}')">üïí HISTORY</button>
            </div>
            <div id="hist-${ex}" class="history-dropdown">${histHtml}</div>
            <div id="sets-${ex}">${setsHtml}</div>
            <button class="btn btn-sec btn-sm" onclick="addSet('${ex}')">+ ADD SET</button>
        </div>`;
    });
}

// --- PLATE CALCULATOR LOGIC ---
let calcTargetId = null;
let calcSideWeight = 0;
let calcBar = 45;

function openCalc(inputId) {
    calcTargetId = inputId;
    calcSideWeight = 0;
    calcBar = 45;
    updateCalcDisplay();
    document.getElementById('modal-plate-calc').style.display = 'flex';
}

function toggleBar() {
    calcBar = calcBar === 45 ? 0 : 45;
    const txt = document.getElementById('bar-status');
    txt.innerText = calcBar === 45 ? "ON" : "OFF";
    txt.style.color = calcBar === 45 ? "var(--success)" : "#555";
    updateCalcDisplay();
}

function addPlate(w) {
    calcSideWeight += w;
    updateCalcDisplay();
}

function resetCalc() {
    calcSideWeight = 0;
    updateCalcDisplay();
}

function updateCalcDisplay() {
    const total = (calcSideWeight * 2) + calcBar;
    document.getElementById('calc-total').innerText = total + " lbs";
}

function applyCalc() {
    const total = (calcSideWeight * 2) + calcBar;
    const el = document.getElementById(calcTargetId);
    if(el) {
        el.value = total;
        // Trigger change event to save
        el.dispatchEvent(new Event('change'));
    }
    document.getElementById('modal-plate-calc').style.display = 'none';
}


function toggleHist(ex) {
    const el = document.getElementById('hist-'+ex);
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

function renderShelf() {
    const area = document.getElementById('tile-area');
    area.innerHTML = "";
    const gymData = getCurrentGymData();
    const list = gymData.library[currentFolder] || [];
    area.innerHTML += `<div class="tile tile-add" onclick="promptNewEx()">+ NEW</div>`;
    list.forEach(ex => {
        area.innerHTML += `<div class="tile" onclick="addToCart('${ex}')">${ex}</div>`;
    });
}

function addToCart(exName) {
    if(!activeCart.includes(exName)) {
        activeCart.push(exName);
        if(!sessionData[exName]) sessionData[exName] = [{w:'', r:''}]; 
        saveSession();
        renderCart();
    }
}

function removeExFromCart(exName) {
    activeCart = activeCart.filter(e => e !== exName);
    delete sessionData[exName];
    saveSession();
    renderCart();
}

function addSet(exName) {
    if(!sessionData[exName]) sessionData[exName] = [];
    sessionData[exName].push({w:'', r:''});
    saveSession();
    renderCart();
}

function removeSet(exName, idx) {
    sessionData[exName].splice(idx, 1);
    saveSession();
    renderCart();
}

function updateSet(exName, idx, field, val) {
    sessionData[exName][idx][field] = val;
    saveSession();
}

function saveSession() {
    localStorage.setItem('activeCart', JSON.stringify(activeCart));
    localStorage.setItem('sessionData', JSON.stringify(sessionData));
}

function promptNewEx() {
    openInputModal("New Exercise", "e.g. Incline Bench", (val) => {
        if(val) {
            const gymData = getCurrentGymData();
            if(!gymData.library[currentFolder]) gymData.library[currentFolder] = [];
            if(!gymData.library[currentFolder].includes(val)) {
                gymData.library[currentFolder].push(val);
                saveAppData(); renderShelf(); addToCart(val);
            }
        }
    });
}

function finishSession() {
    showConfirm("Finish Workout & Save History?", () => {
        let count = 0;
        const today = new Date().toISOString().split('T')[0];

        activeCart.forEach(ex => {
            const sets = sessionData[ex] || [];
            let best1RM = 0;
            let bestStr = "";
            
            sets.forEach(set => {
                const w = parseFloat(set.w);
                const r = parseFloat(set.r);
                if(w && r) {
                    const e1rm = w * (1 + (0.033 * r));
                    if(e1rm > best1RM) {
                        best1RM = e1rm;
                        bestStr = `${w} lbs x ${r}`;
                    }
                    globalLog.push({ date: today, ex: ex, w: w, r: r, rm: Math.round(e1rm) });
                    count++;
                }
            });
            
            if(bestStr) history[ex] = bestStr;
        });
        
        localStorage.setItem('liftHistory', JSON.stringify(history));
        localStorage.setItem('globalLog', JSON.stringify(globalLog));
        
        if(count > 0) {
            activeCart = [];
            sessionData = {};
            saveSession();
            closeSession();
            showToast("Log Saved!");
        } else {
            showToast("Nothing to save.");
        }
    });
}

function exportCSV() {
    if(globalLog.length === 0) { showToast("No history yet"); return; }
    let csvContent = "data:text/csv;charset=utf-8,Date,Exercise,Weight,Reps,Est1RM\n";
    globalLog.forEach(row => { csvContent += `${row.date},${row.ex},${row.w},${row.r},${row.rm}\n`; });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "netgains_data.csv");
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

// --- FOLDER MGMT ---
function promptAddDay() {
    openInputModal("New Folder", "e.g. Chest Day", (val) => {
        if(val) {
             const gymData = getCurrentGymData();
             if(!gymData.folders.includes(val)) {
                 gymData.folders.push(val);
                 saveAppData(); renderDays();
             }
        }
    });
}

function renameFolder(old) {
    openInputModal("Rename", old, (val) => {
        if(val && val !== old) {
            const gymData = getCurrentGymData();
            const idx = gymData.folders.indexOf(old);
            if(idx !== -1) gymData.folders[idx] = val;
            if(gymData.library[old]) { gymData.library[val] = gymData.library[old]; delete gymData.library[old]; }
            saveAppData(); renderDays();
        }
    });
}

function delFolder(name) {
    showConfirm("Delete folder?", () => {
        const gymData = getCurrentGymData();
        gymData.folders = gymData.folders.filter(d => d !== name);
        delete gymData.library[name];
        saveAppData(); renderDays();
        showToast("Folder Deleted");
    });
}

function hidePresets() {
    document.getElementById('preset-area').style.display = 'none';
    localStorage.setItem('hidePresets', 'true');
}

function loadPreset(t) {
    const gymData = getCurrentGymData();
    let a=[]; if(t=='PPL')a=['Push','Pull','Legs']; if(t=='UL')a=['Upper','Lower'];
    a.forEach(d=>{if(!gymData.folders.includes(d)) gymData.folders.push(d)}); 
    saveAppData(); renderDays();
    showToast("Preset Loaded");
}

function saveAppData() {
    localStorage.setItem('netGainsData', JSON.stringify(appData));
}

// --- UI HELPERS ---
function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').innerText = msg;
    t.classList.add('show');
    setTimeout(() => { t.classList.remove('show'); }, 3000);
}

function openInputModal(t, p, cb) {
    const m=document.getElementById('modal-input-overlay'), i=document.getElementById('modal-input'), b=document.getElementById('modal-ok');
    document.getElementById('modal-title').innerText=t; i.value=""; i.placeholder=p; m.style.display='flex'; i.focus();
    let n=b.cloneNode(true); b.parentNode.replaceChild(n,b);
    n.addEventListener('click',()=>{m.style.display='none';cb(i.value)});
}
function closeInputModal(){document.getElementById('modal-input-overlay').style.display='none'}

function showConfirm(msg, cb) {
    const m = document.getElementById('modal-confirm-overlay');
    const b = document.getElementById('confirm-ok');
    document.getElementById('confirm-desc').innerText = msg;
    m.style.display = 'flex';
    let n = b.cloneNode(true); b.parentNode.replaceChild(n,b);
    n.addEventListener('click', () => { m.style.display = 'none'; cb(); });
}
function closeConfirmModal(){document.getElementById('modal-confirm-overlay').style.display='none'}

// --- ENGINE ---
function genProgram() {
    const w = parseFloat(document.getElementById('w').value); const r = parseFloat(document.getElementById('r').value); if(!w || !r) return;
    const rnd=n=>Math.round(n/5)*5; const max=rnd(w*(1+(0.033*r))); const rm5=rnd(max*0.87); const rm3=rnd(max*0.93);
    const weeks = [
        {n:1, t:"BASE",    b:rm5, m:.85,  s:4, r:6},
        {n:2, t:"LOAD",    b:rm5, m:.9,   s:4, r:6},
        {n:3, t:"INTENSE", b:rm5, m:.95,  s:4, r:6},
        {n:4, t:"PEAK",    b:rm5, m:1.05, s:4, r:6},
        {n:5, t:"UNLOAD",  b:rm5, m:.85,  s:2, r:4, f:.9},
        {n:6, t:"SPEED",   b:rm3, m:1,    s:3, r:4, w:.75, f:.85},
        {n:7, t:"FORCE",   b:rm3, m:1,    s:3, r:4, w:.85, f:.9},
        {n:8, t:"MAX",     b:rm3, m:1,    s:3, r:4, w:.7, f:.85}
    ];
    let html = `<div style="text-align:center; margin-bottom:20px; color:#2ed573; font-weight:bold; border:1px solid #333; padding:10px; border-radius:10px;">EST 1RM: ${max} LBS</div>`;
    weeks.forEach(wk=>{ 
        let m=rnd(wk.b*wk.m), wL=rnd(m*(wk.w||.85)), f=rnd(m*(wk.f||.95)); if(wk.n===4) wL=rnd(m*.8); 
        html+=`<div class="week"><div class="week-head"><span>Week ${wk.n}</span><span style="color:#ff4757">${wk.t}</span></div>
        ${row(wk.n, 'Mon', m, 'tag-h', 'H', wk.s, wk.r)} ${row(wk.n, 'Wed', wL, 'tag-l', 'L', wk.s, wk.r)} ${row(wk.n, 'Fri', f, 'tag-m', 'M', wk.s, wk.r)}</div>`; 
    });
    document.getElementById('schedule-area').innerHTML = html;
}
function row(wk, d, l, c, t, s, r) { 
    const id = `w${wk}-${d}`; const done = localStorage.getItem(id) ? 'completed' : ''; 
    const w2=Math.round((l*0.5)/5)*5, w3=Math.round((l*0.7)/5)*5, w4=Math.round((l*0.9)/5)*5;
    return `<div class="${done}" id="row-${id}">
      <div class="day-row" onclick="togW('${id}', this)">
        <div style="display:flex;align-items:center"><span class="chk" onclick="tog('${id}', event)"></span><b>${d}</b><span class="arrow-icon">‚ñº</span></div>
        <div><b>${l} lbs ${s}x${r}</b><span class="tag ${c}">${t}</span></div>
      </div>
      <div id="wu-${id}" class="warmup-box">
         <span class="wu-title">Warm-up Sets</span>
         <div class="wu-row"><span>1. Empty Bar</span><span>10 x 45</span></div>
         <div class="wu-row"><span>2. 50%</span><span>5 x ${w2}</span></div>
         <div class="wu-row"><span>3. 70%</span><span>3 x ${w3}</span></div>
         <div class="wu-row"><span>4. 90% (Primer)</span><span>1 x ${w4}</span></div>
      </div>
    </div>`; 
}
function tog(id, e) { e.stopPropagation(); const el = document.getElementById('row-'+id); if(el.classList.contains('completed')) { el.classList.remove('completed'); localStorage.removeItem(id); } else { el.classList.add('completed'); localStorage.setItem(id,'1'); } }
function togW(id, el) { const w = document.getElementById('wu-'+id); w.style.display = w.style.display === 'block' ? 'none' : 'block'; el.classList.toggle('open'); }
function nuke() { showConfirm("DELETE ALL DATA? This cannot be undone.", () => { localStorage.clear(); location.reload(); }); }
</script>
</body>
</html>
