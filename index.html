<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f13">
<title>NetGains AI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  /* --- 1. VARIABLES & RESET --- */
  :root { --bg: #0f0f13; --card: #1a1a24; --text: #ffffff; --accent: #ff4757; --success: #2ed573; --drop: #ff6b81; --super: #a29bfe; --input-bg: #121212; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; padding: 0; background-color: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; overflow-x: hidden; padding-bottom: 90px; }

  /* --- 2. UTILS --- */
  .hidden { display: none !important; }
  .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 13px; margin-top: 10px; transition: 0.1s; }
  .btn:active { transform: scale(0.98); }
  .btn-main { background: linear-gradient(135deg, #ff4757, #ff6b81); color: white; }
  .btn-sec { background: #333; color: white; border: 1px solid #444; }
  .btn-sm { padding: 8px; font-size: 11px; width: auto; display: inline-block; margin: 0; }
  .btn-icon { background: none; border: none; font-size: 16px; cursor: pointer; color: #888; padding: 5px; }
  
  h1 { text-align: center; margin: 25px 0 5px; font-size: 26px; letter-spacing: -1px; font-weight: 900; color: white; }
  .brand-span { color: var(--accent); }
  .sub { text-align: center; color: var(--dim); font-size: 11px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 25px; }
  input { background: var(--input-bg); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; font-size: 16px; margin-bottom: 5px; }
  input:focus { outline:none; border-color: var(--accent); }

  /* --- 3. LAYOUT --- */
  .view { padding: 20px; max-width: 600px; margin: 0 auto; animation: fade 0.3s; }
  @keyframes fade { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

  /* --- 4. PROGRAM STYLES --- */
  .week { background: var(--card); border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; overflow: hidden; }
  .week-head { display: flex; justify-content: space-between; padding: 15px; background: #222; border-bottom: 1px solid #333; font-weight: bold; }
  .day-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #222; align-items: center; cursor: pointer; }
  .tag { font-size: 9px; padding: 3px 6px; border-radius: 4px; color: black; font-weight: 800; margin-left: 8px; text-transform: uppercase; }
  .tag-h { background: #ff4757; } .tag-l { background: #2ed573; } .tag-m { background: #ffa502; }
  .chk { width: 22px; height: 22px; border: 2px solid #555; border-radius: 50%; margin-right: 12px; display: inline-block; }
  .completed .chk { background: var(--success); border-color: var(--success); }
  .completed { text-decoration: line-through; opacity: 0.5; color: var(--success); }
  .warmup-box { background: #151515; border-top: 1px solid #333; padding: 10px 15px; display: none; }
  .wu-row { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 5px; }
  .wu-title { color: #ffa502; font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 8px; display: block; }

  /* --- 5. LOG STYLES --- */
  .gym-selector-header { background: #222; border: 1px solid #333; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  .gym-label { font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
  .gym-name { font-weight: 800; font-size: 15px; color: var(--accent); margin-top: 2px; }

  .day-card { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #333; transition: 0.1s; }
  .day-card:active { transform: scale(0.99); border-color: #555; }
  .icon-btn { background: #222; border: 1px solid #444; color: #ccc; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }

  /* SESSION */
  .ex-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; position: relative; }
  .ex-top { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
  .ex-name { font-weight: bold; font-size: 16px; }
  .ex-header-tools { display: flex; gap: 8px; }
  .toggle-lr { font-size: 10px; background: #222; color: #666; padding: 4px 8px; border-radius: 4px; border: 1px solid #444; cursor: pointer; }
  .toggle-lr.active { background: var(--accent); color: white; border-color: var(--accent); }

  /* SET ROWS */
  .set-row { display: grid; grid-template-columns: 30px 1fr 40px 1fr 25px 25px; gap: 5px; align-items: center; margin-bottom: 8px; padding: 4px; border-radius: 6px; }
  .set-row.drop { border: 1px solid var(--drop); background: rgba(255, 107, 129, 0.1); }
  .set-row.super { border: 1px solid var(--super); background: rgba(162, 155, 254, 0.1); }
  .set-num { color: #666; font-size: 12px; font-weight: bold; text-align: center; }
  .del-set { color: #555; background: none; border: none; font-size: 16px; cursor: pointer; }
  .calc-btn { background: #222; border: 1px solid #444; color: var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; height: 42px; }
  .opt-btn { background: none; border: none; color: #888; font-weight: bold; cursor: pointer; font-size: 14px; }

  /* MODALS */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .modal-box { background: #1e1e1e; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  
  /* QR MODAL */
  #qrcode { background: white; padding: 10px; border-radius: 10px; margin: 20px auto; width: fit-content; }
  
  /* PLATE CALC MODAL */
  .plate-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
  .p-btn { background: #222; border: 1px solid #444; color: white; padding: 15px 0; border-radius: 8px; font-weight: bold; cursor: pointer; }
  .calc-display { text-align: center; font-size: 24px; font-weight: bold; color: var(--success); margin-bottom: 15px; padding: 10px; background: #111; border-radius: 8px; }
  
  /* NAV */
  .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: #181818; border-top: 1px solid #333; display: grid; grid-template-columns: 1fr 1fr 1fr; z-index: 1000; padding-bottom: 20px; }
  .nav-btn { background: none; border: none; color: #666; font-size: 10px; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
  .nav-btn.active { color: var(--accent); }
  .nav-icon { font-size: 22px; margin-bottom: 5px; }
  #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid #333; color: white; padding: 12px 24px; border-radius: 30px; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 3000; }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
</style>
</head>
<body>

<div id="modal-share" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title" style="text-align:center">Share Routine</h3>
    <div id="qrcode"></div>
    <p style="font-size:10px; color:#666; text-align:center;">Scan to import</p>
    <button class="btn btn-main" onclick="copyShareLink()">COPY LINK</button>
    <button class="btn btn-sec" onclick="document.getElementById('modal-share').style.display='none'">CLOSE</button>
  </div>
</div>

<div id="modal-set-opt" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title">Set Type</h3>
    <button class="btn btn-sec" onclick="applySetType('')">Normal</button>
    <button class="btn btn-sec" style="border-color:var(--drop); color:var(--drop);" onclick="applySetType('drop')">üíß Drop Set</button>
    <button class="btn btn-sec" style="border-color:var(--super); color:var(--super);" onclick="applySetType('super')">üîó Superset</button>
    <button class="btn btn-sec" style="margin-top:20px" onclick="document.getElementById('modal-set-opt').style.display='none'">CANCEL</button>
  </div>
</div>

<div id="modal-import" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title">Incoming Routine</h3>
    <p class="modal-desc" id="import-desc">Import workout?</p>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn btn-sec" onclick="document.getElementById('modal-import').style.display='none'">NO</button>
      <button class="btn btn-main" onclick="confirmImport()">YES, SAVE</button>
    </div>
  </div>
</div>

<div id="modal-input-overlay" class="modal-overlay"><div class="modal-box"><h3 id="modal-title" class="modal-title">Input</h3><input type="text" id="modal-input"><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;"><button class="btn btn-sec" onclick="closeInputModal()">CANCEL</button><button class="btn btn-main" id="modal-ok">SAVE</button></div></div></div>
<div id="modal-plate-calc" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">Plate Math</h3><div class="calc-display" id="calc-total">45 lbs</div><div class="bar-toggle" onclick="toggleBar()" style="display:flex;justify-content:space-between;background:#222;padding:10px;border-radius:6px;margin-bottom:15px;font-size:12px;"><span>Bar (45lbs)</span><span id="bar-status" style="color:var(--success)">ON</span></div><div class="plate-grid"><button class="p-btn" onclick="addPlate(45)">45</button><button class="p-btn" onclick="addPlate(35)">35</button><button class="p-btn" onclick="addPlate(25)">25</button><button class="p-btn" onclick="addPlate(10)">10</button><button class="p-btn" onclick="addPlate(5)">5</button><button class="p-btn" onclick="addPlate(2.5)">2.5</button></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-sec" onclick="resetCalc()">RESET</button><button class="btn btn-main" onclick="applyCalc()">USE</button></div></div></div>
<div id="modal-confirm-overlay" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">Confirm</h3><p id="confirm-desc" class="modal-desc">Sure?</p><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-sec" onclick="closeConfirmModal()">CANCEL</button><button class="btn btn-main" id="confirm-ok" style="background:#333">YES</button></div></div></div>
<div id="toast"><span class="toast-icon">‚úì</span> <span id="toast-msg">Saved</span></div>

<div id="view-program" class="view">
  <h1>NETGAINS <span class="brand-span">AI</span></h1>
  <p class="sub">ENGINE</p>
  <div style="background:#222; padding:15px; border-radius:12px; border:1px solid #333; margin-bottom:20px;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <input type="number" id="w" placeholder="Weight (lbs)">
        <input type="number" id="r" placeholder="Reps">
    </div>
    <button class="btn btn-main" onclick="genProgram()">Generate 8-Week Cycle</button>
  </div>
  <div id="schedule-area"></div>
</div>

<div id="view-log" class="view hidden">
  <h1>TRAINING LOG</h1>
  <p class="sub">TRACKER</p>

  <div class="gym-selector-header" onclick="showGymManager()">
      <div><div class="gym-label">CURRENT LOCATION</div><div class="gym-name" id="current-gym-display">Main Gym</div></div>
      <div style="color:#666">‚ñº</div>
  </div>

  <div id="gym-manager" class="hidden">
      <h3 style="color:var(--dim); font-size:12px; margin-bottom:15px;">GYMS</h3>
      <div id="gym-list"></div>
      <button class="btn btn-sec" style="border-style:dashed; margin-top:15px;" onclick="promptAddGym()">+ ADD NEW GYM</button>
      <button class="btn btn-sec" style="margin-top:20px;" onclick="closeGymManager()">‚Üê BACK</button>
  </div>

  <div id="split-manager">
      <div id="my-split-list"></div>
      <button class="btn btn-sec" style="border-style:dashed; color:#888;" onclick="promptAddDay()">+ NEW FOLDER</button>
  </div>

  <div id="session-logger" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; align-items:center;">
            <button class="btn btn-sec" onclick="closeSession()" style="width:auto; margin:0; padding:10px 15px;">‚Üê</button>
            <h2 id="session-title" style="margin:0 0 0 15px; color:var(--accent); font-size:20px;"></h2>
        </div>
        <button class="btn-ghost" onclick="clearCart()">RESET</button>
      </div>
      <div id="active-workout-area"></div>
      <button class="btn btn-main" onclick="finishSession()">FINISH & SAVE LOG</button>
      <div class="shelf-title">EXERCISE LIBRARY</div>
      <div id="tile-area" class="tile-grid"></div>
  </div>
</div>

<div id="view-tools" class="view hidden">
  <h1>TOOLS</h1>
  <p class="sub">UTILITIES</p>
  <div class="tool-box" style="background:#1a1a24; padding:20px; border-radius:15px; border:1px solid #333; text-align:center; margin-bottom:15px;">
      <h3 style="margin:0 0 15px 0; color:var(--accent)">DATA</h3>
      <button class="btn btn-sec" onclick="exportCSV()">DOWNLOAD CSV</button>
  </div>
  <div class="tool-box" style="background:#1a1a24; padding:20px; border-radius:15px; border:1px solid #333; text-align:center; margin-bottom:15px;">
      <h3 style="margin:0 0 15px 0; color:var(--accent)">REST TIMER</h3>
      <div style="font-size:45px; font-weight:900; margin:15px 0;" id="t-disp">00:00</div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
          <button class="btn btn-sec" onclick="startTimer(90)">90s</button>
          <button class="btn btn-sec" onclick="startTimer(180)">3m</button>
          <button class="btn btn-sec" onclick="startTimer(300)">5m</button>
      </div>
      <button class="btn btn-main" style="margin-top:10px; background:#333;" onclick="clearInterval(timer);document.getElementById('t-disp').innerText='00:00'">STOP</button>
  </div>
  <div class="tool-box" style="background:#1a1a24; padding:20px; border-radius:15px; border:1px solid #333; text-align:center; margin-bottom:15px;">
      <h3 style="margin:0 0 15px 0; color:var(--accent)">PLATE CALC</h3>
      <input type="number" id="pIn" placeholder="Weight (lbs)">
      <button class="btn btn-main" style="background:var(--success); color:black;" onclick="calcPlates()">CALCULATE</button>
      <div id="pOut" style="margin-top:15px;"></div>
  </div>
  <div class="tool-box" style="padding:20px; text-align:center;">
      <button class="btn btn-danger" onclick="nuke()">FACTORY RESET APP</button>
  </div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="switchTab('program', this)"><span>üìä</span> PROGRAM</button>
    <button class="nav-btn" onclick="switchTab('log', this)"><span>üìù</span> LOG</button>
    <button class="nav-btn" onclick="switchTab('tools', this)"><span>‚öí</span> TOOLS</button>
</div>

<script>
// --- CORE DATA ---
let appData = JSON.parse(localStorage.getItem('netGainsData') || 'null');
if (!appData) {
    const oldDays = JSON.parse(localStorage.getItem('myDays') || '[]');
    const oldLib = JSON.parse(localStorage.getItem('myLibrary') || '{}');
    appData = { currentGym: 'Main Gym', gyms: { 'Main Gym': { folders: oldDays, library: oldLib } } };
    localStorage.setItem('netGainsData', JSON.stringify(appData));
}
let activeCart = JSON.parse(localStorage.getItem('activeCart') || '[]'); 
let sessionData = JSON.parse(localStorage.getItem('sessionData') || '{}'); 
let history = JSON.parse(localStorage.getItem('liftHistory') || '{}'); 
let globalLog = JSON.parse(localStorage.getItem('globalLog') || '[]');

// --- IMPORT LOGIC ---
const urlParams = new URLSearchParams(window.location.search);
const importData = urlParams.get('import');
if(importData) {
    try {
        const decoded = JSON.parse(atob(importData));
        document.getElementById('import-desc').innerText = `Import folder "${decoded.name}" with ${decoded.exs.length} exercises?`;
        document.getElementById('modal-import').style.display = 'flex';
        window.tempImport = decoded;
    } catch(e) { console.log("Import error"); }
}
function confirmImport() {
    const gymData = getCurrentGymData();
    const name = window.tempImport.name;
    if(!gymData.folders.includes(name)) gymData.folders.push(name);
    gymData.library[name] = window.tempImport.exs;
    saveAppData();
    renderDays();
    document.getElementById('modal-import').style.display = 'none';
    window.history.replaceState({}, document.title, "/"); // Clean URL
    showToast("Imported Successfully!");
}

// --- APP INIT ---
renderDays();

function switchTab(id, btn) {
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    document.getElementById('view-'+id).classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// --- GYM LOGIC ---
function getCurrentGymData() {
    if(!appData.gyms[appData.currentGym]) appData.gyms[appData.currentGym] = { folders: [], library: {} };
    return appData.gyms[appData.currentGym];
}
function showGymManager() { document.getElementById('split-manager').classList.add('hidden'); document.getElementById('gym-manager').classList.remove('hidden'); renderGymList(); }
function closeGymManager() { document.getElementById('gym-manager').classList.add('hidden'); document.getElementById('split-manager').classList.remove('hidden'); }
function renderGymList() {
    const div = document.getElementById('gym-list'); div.innerHTML = "";
    Object.keys(appData.gyms).forEach(gym => {
        const isActive = (gym === appData.currentGym);
        div.innerHTML += `<div class="day-card" style="${isActive?'border:1px solid var(--accent)':''}">
            <div style="flex-grow:1; cursor:pointer;" onclick="selectGym('${gym}')"><b>${gym}</b>${isActive?' <span style="font-size:9px;background:var(--accent);padding:2px 4px;border-radius:4px;">ACTIVE</span>':''}</div>
            <div style="display:flex; gap:8px;"><button class="icon-btn" onclick="delGym('${gym}')">‚úï</button></div></div>`;
    });
}
function selectGym(name) { appData.currentGym = name; saveAppData(); renderDays(); closeGymManager(); showToast("Switched"); }
function promptAddGym() { openInputModal("New Gym", "Name", (val) => { if(val){ appData.gyms[val]={folders:[],library:{}}; selectGym(val); } }); }
function delGym(name) { if(Object.keys(appData.gyms).length<=1)return; showConfirm("Delete?",()=>{ delete appData.gyms[name]; selectGym(Object.keys(appData.gyms)[0]); }); }

// --- SHARING LOGIC ---
function shareFolder(name) {
    const gymData = getCurrentGymData();
    const data = { name: name, exs: gymData.library[name] || [] };
    const str = btoa(JSON.stringify(data));
    const link = window.location.origin + window.location.pathname + "?import=" + str;
    
    // QR
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById("qrcode"), { text: link, width: 128, height: 128 });
    
    // Store link for copy
    window.shareLink = link;
    document.getElementById('modal-share').style.display = 'flex';
}
function copyShareLink() {
    navigator.clipboard.writeText(window.shareLink).then(() => showToast("Link Copied!"));
}

// --- FOLDER LIST ---
function renderDays() {
    const gymData = getCurrentGymData();
    document.getElementById('current-gym-display').innerText = appData.currentGym;
    const list = document.getElementById('my-split-list'); list.innerHTML = "";
    gymData.folders.forEach((day) => {
        const count = (gymData.library[day]||[]).length;
        list.innerHTML += `<div class="day-card">
            <div style="flex-grow:1; cursor:pointer;" onclick="openSession('${day}')"><b>${day}</b><br><span style="font-size:11px; color:#666;">${count} Ex</span></div>
            <div style="display:flex; gap:5px;">
                <button class="icon-btn" onclick="shareFolder('${day}')">‚û¶</button>
                <button class="icon-btn" onclick="renameFolder('${day}')">‚úé</button>
                <button class="icon-btn" onclick="delFolder('${day}')">‚úï</button>
            </div></div>`;
    });
}

// --- SESSION LOGIC ---
let currentFolder = "";
function openSession(day) { currentFolder = day; document.getElementById('split-manager').classList.add('hidden'); document.getElementById('session-logger').classList.remove('hidden'); document.getElementById('session-title').innerText = day; renderCart(); renderShelf(); }
function closeSession() { document.getElementById('session-logger').classList.add('hidden'); document.getElementById('split-manager').classList.remove('hidden'); }
function clearCart() { showConfirm("Clear workout?", () => { activeCart=[]; sessionData={}; saveSession(); renderCart(); }); }

function renderCart() {
    const area = document.getElementById('active-workout-area'); area.innerHTML = "";
    if(activeCart.length===0) { area.innerHTML="<div style='text-align:center;padding:30px;color:#555;'>Empty Workout</div>"; return; }
    
    activeCart.forEach((ex) => {
        const sets = sessionData[ex] || [];
        const isLR = sessionData[ex + '_LR'] === true; // Check if L/R mode is active
        
        let setsHtml = "";
        sets.forEach((set, idx) => {
            const inputId = `w-${ex}-${idx}`;
            // Determine label (Num or L/R)
            let label = idx + 1;
            if (set.side) label = set.side; 

            setsHtml += `
            <div class="set-row ${set.type || ''}">
                <span class="set-num">${label}</span>
                <input type="number" id="${inputId}" placeholder="Lbs" value="${set.w}" onchange="updateSet('${ex}', ${idx}, 'w', this.value)">
                <button class="calc-btn" onclick="openCalc('${inputId}')">üßÆ</button>
                <input type="number" placeholder="Reps" value="${set.r}" onchange="updateSet('${ex}', ${idx}, 'r', this.value)">
                <button class="opt-btn" onclick="openSetOpt('${ex}', ${idx})">...</button>
                <button class="del-set" onclick="removeSet('${ex}', ${idx})">‚úï</button>
            </div>`;
        });

        area.innerHTML += `
        <div class="ex-card">
            <div class="ex-top">
                <span class="ex-name">${ex}</span>
                <div class="ex-header-tools">
                   <div class="toggle-lr ${isLR ? 'active' : ''}" onclick="toggleLR('${ex}')">L+R</div>
                   <button onclick="removeExFromCart('${ex}')" style="background:none;border:none;color:#555;">‚úï</button>
                </div>
            </div>
            <div id="sets-${ex}">${setsHtml}</div>
            <button class="btn btn-sec btn-sm" onclick="addSet('${ex}')">+ ADD SET</button>
        </div>`;
    });
}

// --- SET LOGIC (V9 UPDATES) ---
let optTarget = null;
function openSetOpt(ex, idx) { optTarget = {ex, idx}; document.getElementById('modal-set-opt').style.display = 'flex'; }
function applySetType(type) {
    if(optTarget) {
        sessionData[optTarget.ex][optTarget.idx].type = type;
        saveSession(); renderCart();
        document.getElementById('modal-set-opt').style.display = 'none';
    }
}

function toggleLR(ex) {
    const current = sessionData[ex + '_LR'] === true;
    sessionData[ex + '_LR'] = !current;
    saveSession(); renderCart();
}

function addSet(ex) {
    if(!sessionData[ex]) sessionData[ex] = [];
    
    // Check if L/R mode is ON
    if(sessionData[ex + '_LR'] === true) {
        // Add Left AND Right
        sessionData[ex].push({w:'', r:'', side:'L'});
        sessionData[ex].push({w:'', r:'', side:'R'});
    } else {
        sessionData[ex].push({w:'', r:''});
    }
    saveSession(); renderCart();
}

function removeSet(ex, idx) { sessionData[ex].splice(idx, 1); saveSession(); renderCart(); }
function updateSet(ex, idx, field, val) { sessionData[ex][idx][field] = val; saveSession(); }

function renderShelf() {
    const area = document.getElementById('tile-area'); area.innerHTML = "";
    const gymData = getCurrentGymData();
    const list = gymData.library[currentFolder] || [];
    area.innerHTML += `<div class="tile tile-add" onclick="promptNewEx()">+ NEW</div>`;
    list.forEach(ex => { area.innerHTML += `<div class="tile" onclick="addToCart('${ex}')">${ex}</div>`; });
}
function addToCart(ex) { if(!activeCart.includes(ex)) { activeCart.push(ex); if(!sessionData[ex]) sessionData[ex] = [{w:'', r:''}]; saveSession(); renderCart(); } }
function removeExFromCart(ex) { activeCart = activeCart.filter(e => e !== ex); delete sessionData[ex]; saveSession(); renderCart(); }
function promptNewEx() { openInputModal("New Exercise", "Name", (val) => { if(val){ const gd=getCurrentGymData(); if(!gd.library[currentFolder])gd.library[currentFolder]=[]; gd.library[currentFolder].push(val); saveAppData(); renderShelf(); addToCart(val); } }); }

function saveSession() { localStorage.setItem('activeCart', JSON.stringify(activeCart)); localStorage.setItem('sessionData', JSON.stringify(sessionData)); }
function saveAppData() { localStorage.setItem('netGainsData', JSON.stringify(appData)); }

function finishSession() {
    showConfirm("Save Log?", () => {
        let count = 0; const today = new Date().toISOString().split('T')[0];
        activeCart.forEach(ex => {
            const sets = sessionData[ex] || [];
            let best1RM = 0; let bestStr = "";
            sets.forEach(set => {
                const w = parseFloat(set.w); const r = parseFloat(set.r);
                if(w && r) {
                    const e1rm = w * (1 + (0.033 * r));
                    if(e1rm > best1RM) { best1RM = e1rm; bestStr = `${w} lbs x ${r}`; }
                    globalLog.push({ date: today, ex: ex, w: w, r: r, rm: Math.round(e1rm), type: set.type||'', side: set.side||'' });
                    count++;
                }
            });
            if(bestStr) history[ex] = bestStr;
        });
        localStorage.setItem('liftHistory', JSON.stringify(history)); localStorage.setItem('globalLog', JSON.stringify(globalLog));
        if(count>0){ activeCart=[]; sessionData={}; saveSession(); closeSession(); showToast("Saved"); }
    });
}

// --- HELPERS ---
function promptAddDay() { openInputModal("New Folder", "Name", (val) => { if(val){ const gd=getCurrentGymData(); if(!gd.folders.includes(val)) gd.folders.push(val); saveAppData(); renderDays(); } }); }
function renameFolder(old) { openInputModal("Rename", old, (val) => { if(val && val!==old){ const gd=getCurrentGymData(); const idx=gd.folders.indexOf(old); if(idx!==-1)gd.folders[idx]=val; if(gd.library[old]){gd.library[val]=gd.library[old];delete gd.library[old];} saveAppData(); renderDays(); } }); }
function delFolder(name) { showConfirm("Delete?",()=>{ const gd=getCurrentGymData(); gd.folders=gd.folders.filter(d=>d!==name); delete gd.library[name]; saveAppData(); renderDays(); }); }
function showToast(msg) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
function openInputModal(t, p, cb) { const m=document.getElementById('modal-input-overlay'), i=document.getElementById('modal-input'), b=document.getElementById('modal-ok'); document.getElementById('modal-title').innerText=t; i.value=""; i.placeholder=p; m.style.display='flex'; i.focus(); let n=b.cloneNode(true); b.parentNode.replaceChild(n,b); n.addEventListener('click',()=>{m.style.display='none';cb(i.value)}); }
function closeInputModal(){document.getElementById('modal-input-overlay').style.display='none'}
function showConfirm(msg, cb) { const m=document.getElementById('modal-confirm-overlay'), b=document.getElementById('confirm-ok'); document.getElementById('confirm-desc').innerText=msg; m.style.display='flex'; let n=b.cloneNode(true); b.parentNode.replaceChild(n,b); n.addEventListener('click',()=>{m.style.display='none';cb()}); }
function closeConfirmModal(){document.getElementById('modal-confirm-overlay').style.display='none'}
function nuke() { showConfirm("DELETE ALL?", () => { localStorage.clear(); location.reload(); }); }
function exportCSV() { if(globalLog.length===0){showToast("No data");return;} let c="Date,Exercise,Weight,Reps,Side,Type\n"; globalLog.forEach(l=>{c+=`${l.date},${l.ex},${l.w},${l.r},${l.side||''},${l.type||''}\n`}); const b=document.createElement('a'); b.href=encodeURI("data:text/csv;charset=utf-8,"+c); b.download="netgains_data.csv"; document.body.appendChild(b); b.click(); }

// --- PLATE CALC ---
let calcTargetId=null, calcSideWeight=0, calcBar=45;
function openCalc(id){ calcTargetId=id; calcSideWeight=0; calcBar=45; updateCalcDisplay(); document.getElementById('modal-plate-calc').style.display='flex'; }
function toggleBar(){ calcBar=calcBar===45?0:45; document.getElementById('bar-status').innerText=calcBar===45?"ON":"OFF"; document.getElementById('bar-status').style.color=calcBar===45?"var(--success)":"#555"; updateCalcDisplay(); }
function addPlate(w){ calcSideWeight+=w; updateCalcDisplay(); }
function resetCalc(){ calcSideWeight=0; updateCalcDisplay(); }
function updateCalcDisplay(){ document.getElementById('calc-total').innerText=((calcSideWeight*2)+calcBar)+" lbs"; }
function applyCalc(){ if(calcTargetId){document.getElementById(calcTargetId).value=((calcSideWeight*2)+calcBar);document.getElementById(calcTargetId).dispatchEvent(new Event('change'));} document.getElementById('modal-plate-calc').style.display='none'; }
function genProgram(){ const w=parseFloat(document.getElementById('w').value), r=parseFloat(document.getElementById('r').value); if(!w||!r)return; const rnd=n=>Math.round(n/5)*5, max=rnd(w*(1+(0.033*r))), rm5=rnd(max*0.87), rm3=rnd(max*0.93); const weeks=[{n:1,t:"BASE",b:rm5,m:.85,s:4,r:6},{n:2,t:"LOAD",b:rm5,m:.9,s:4,r:6},{n:3,t:"INTENSE",b:rm5,m:.95,s:4,r:6},{n:4,t:"PEAK",b:rm5,m:1.05,s:4,r:6},{n:5,t:"UNLOAD",b:rm5,m:.85,s:2,r:4,f:.9},{n:6,t:"SPEED",b:rm3,m:1,s:3,r:4,w:.75,f:.85},{n:7,t:"FORCE",b:rm3,m:1,s:3,r:4,w:.85,f:.9},{n:8,t:"MAX",b:rm3,m:1,s:3,r:4,w:.7,f:.85}]; let h=`<div style="text-align:center;margin-bottom:20px;color:var(--success);font-weight:bold;border:1px solid #333;padding:10px;border-radius:10px;">EST 1RM: ${max} LBS</div>`; weeks.forEach(k=>{let m=rnd(k.b*k.m), wL=rnd(m*(k.w||.85)), f=rnd(m*(k.f||.95)); if(k.n===4)wL=rnd(m*.8); h+=`<div class="week"><div class="week-head"><span>Week ${k.n}</span><span style="color:#ff4757">${k.t}</span></div><div class="day-row"><div><b>Mon</b></div><div>${m} lbs ${k.s}x${k.r} <span class="tag tag-h">H</span></div></div><div class="day-row"><div><b>Wed</b></div><div>${wL} lbs ${k.s}x${k.r} <span class="tag tag-l">L</span></div></div><div class="day-row"><div><b>Fri</b></div><div>${f} lbs ${k.s}x${k.r} <span class="tag tag-m">M</span></div></div></div>`;}); document.getElementById('schedule-area').innerHTML=h; }
let timer; function startTimer(s){ clearInterval(timer); const end=Date.now()+s*1000; timer=setInterval(()=>{const r=Math.round((end-Date.now())/1000); if(r<0){clearInterval(timer);document.getElementById('t-disp').innerText="DONE";return;} const m=Math.floor(r/60), rs=r%60; document.getElementById('t-disp').innerText=`${m}:${rs<10?'0':''}${rs}`;},1000); }
</script>
</body>
</html>
