<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f13">
<title>NetGains AI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  /* --- 1. VARIABLES & RESET --- */
  :root { 
    --bg: #0f0f13; --card: #1a1a24; --text: #ffffff; 
    --accent: #ff4757; --success: #2ed573; 
    --drop: #ff6b81; --super: #a29bfe; --assist: #00d2d3; --cardio: #ffa502; 
    --input-bg: #121212; 
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; padding: 0; background-color: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; overflow-x: hidden; padding-bottom: 90px; }

  /* --- 2. UTILS --- */
  .hidden { display: none !important; }
  .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 13px; margin-top: 10px; transition: 0.1s; }
  .btn:active { transform: scale(0.98); }
  .btn-main { background: linear-gradient(135deg, #ff4757, #ff6b81); color: white; }
  .btn-sec { background: #333; color: white; border: 1px solid #444; }
  .btn-ghost { background: transparent; border: 1px dashed #444; color: #666; font-size: 10px; padding: 6px 10px; width: auto; display: inline-block; cursor: pointer; border-radius: 6px; }
  .btn-sm { padding: 8px; font-size: 11px; width: auto; display: inline-block; margin: 0; }
  
  h1 { text-align: center; margin: 25px 0 5px; font-size: 26px; letter-spacing: -1px; font-weight: 900; color: white; }
  .brand-span { color: var(--accent); }
  .sub { text-align: center; color: var(--dim); font-size: 11px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 25px; }
  
  /* INPUTS & LABELS */
  input { background: var(--input-bg); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; font-size: 16px; margin-bottom: 5px; }
  input:focus { outline:none; border-color: var(--accent); }
  
  .input-wrapper { position: relative; width: 100%; }
  .input-wrapper input { padding-right: 35px; text-align: center; } 
  .input-unit { position: absolute; right: 8px; top: 42%; transform: translateY(-50%); color: #555; font-size: 9px; pointer-events: none; font-weight: 800; text-transform: uppercase; }

  /* --- 3. LAYOUT --- */
  .view { padding: 20px; max-width: 600px; margin: 0 auto; animation: fade 0.3s; }
  @keyframes fade { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

  /* --- 4. COMPONENTS --- */
  .gym-selector-header { background: #222; border: 1px solid #333; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; cursor: pointer; }
  .gym-label { font-size: 10px; color: #888; text-transform: uppercase; }
  .gym-name { font-weight: bold; font-size: 14px; color: var(--accent); }

  .day-card { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #333; transition: 0.1s; }
  .icon-btn { background: #222; border: 1px solid #444; color: #ccc; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }

  .ex-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
  .ex-top { display: flex; justify-content: space-between; margin-bottom: 5px; align-items: center; }
  .ex-name { font-weight: bold; font-size: 16px; }
  .ex-tools { display: flex; gap: 10px; align-items: center; }
  .ex-hist { font-size: 11px; color: var(--success); font-weight: bold; margin-bottom: 12px; opacity: 0.8; }
  
  .toggle-lr { font-size: 10px; background: #222; color: #666; padding: 5px 10px; border-radius: 4px; border: 1px solid #444; cursor: pointer; font-weight: bold; }
  .toggle-lr.active { background: var(--accent); color: white; border-color: var(--accent); }

  /* SET ROWS */
  .set-row { display: grid; grid-template-columns: 35px 1fr 40px 1fr 30px 30px; gap: 6px; align-items: center; margin-bottom: 8px; }
  .cardio-row { display: grid; grid-template-columns: 30px 1fr 1fr 1fr 30px; gap: 6px; align-items: center; margin-bottom: 8px; }

  /* SET GROUPS */
  .set-group-box { border: 1px solid #444; border-left-width: 4px; padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.03); margin-bottom: 8px; }
  .set-group-drop { border-left-color: var(--drop); }
  .set-group-super { border-left-color: var(--super); }
  .set-group-assist { border-left-color: var(--assist); }
  .set-container { margin-bottom: 4px; }
  
  .set-num { color: #666; font-size: 12px; font-weight: bold; text-align: center; }

  /* BUTTON FIXES */
  .calc-btn { background: #222; border: 1px solid #444; color: var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; height: 42px; transition: 0.1s; }
  .calc-btn:active { background: var(--accent); color: black; transform: scale(0.95); }
  
  .menu-btn { background: none; border: 1px solid #333; color: #888; border-radius: 6px; cursor: pointer; height: 42px; display: flex; align-items: center; justify-content: center; font-weight: bold; padding-bottom: 5px; }
  .del-btn { background: none; border: none; color: #555; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; height: 42px; }

  /* SHELF */
  .shelf-title { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; border-top: 1px solid #333; padding-top: 20px; margin-top: 20px; }
  .tile-grid { display: flex; flex-wrap: wrap; gap: 8px; }
  .tile { display: inline-flex; align-items: center; justify-content: center; background: #222; border: 1px solid #444; color: #ccc; padding: 12px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: 500; transition: 0.1s; }
  .tile:active { background: var(--accent); color: black; border-color: var(--accent); }
  .tile-add { border: 1px dashed #666; color: #888; background: transparent; }

  /* MODALS */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .modal-box { background: #1e1e1e; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  
  #qrcode { background: white; padding: 10px; border-radius: 10px; margin: 20px auto; width: fit-content; }
  #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid #333; color: white; padding: 12px 24px; border-radius: 30px; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 3000; }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
  
  /* PLATE CALC */
  .plate-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
  .p-btn { background: #222; border: 1px solid #444; color: white; padding: 15px 0; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.1s; }
  .p-btn:active { background: #444; transform: scale(0.95); }
  
  .calc-input { text-align: center; font-size: 24px; font-weight: bold; color: var(--success); margin-bottom: 15px; padding: 10px; background: #111; border-radius: 8px; border: 1px solid #333; width: 100%; }
  .import-textarea { width: 100%; background: #111; color: #0f0; font-family: monospace; border: 1px solid #333; border-radius: 5px; padding: 10px; font-size: 10px; height: 60px; margin-bottom: 10px; }

  .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: #181818; border-top: 1px solid #333; display: grid; grid-template-columns: 1fr 1fr 1fr; z-index: 1000; padding-bottom: 20px; }
  .nav-btn { background: none; border: none; color: #666; font-size: 10px; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
  .nav-btn.active { color: var(--accent); }

  /* PROGRAM STYLES */
  .week { background: var(--card); border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; overflow: hidden; }
  .week-head { display: flex; justify-content: space-between; padding: 15px; background: #222; border-bottom: 1px solid #333; font-weight: bold; }
  .day-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #222; align-items: center; cursor: pointer; }
  .tag { font-size: 9px; padding: 3px 6px; border-radius: 4px; color: black; font-weight: 800; margin-left: 8px; text-transform: uppercase; }
  .tag-h { background: #ff4757; } .tag-l { background: #2ed573; } .tag-m { background: #ffa502; }
  .chk { width: 22px; height: 22px; border: 2px solid #555; border-radius: 50%; margin-right: 12px; display: inline-block; }
  .completed .chk { background: var(--success); border-color: var(--success); }
  .completed { text-decoration: line-through; opacity: 0.5; color: var(--success); }
</style>
</head>
<body>

<div id="modal-bridge" class="modal-overlay">
  <div class="modal-box" style="text-align:center;">
    <h3 class="modal-title" style="color:var(--success)">WORKOUT RECEIVED</h3>
    <button class="btn btn-main" onclick="copyBridgeCode()">üìã COPY CODE</button>
    <button class="btn btn-sec" style="margin-top:10px" onclick="document.getElementById('modal-bridge').style.display='none'">CLOSE</button>
  </div>
</div>

<div id="modal-manual-import" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title">Import</h3>
    <textarea id="import-area" class="import-textarea" placeholder="Paste code..."></textarea>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn btn-sec" onclick="document.getElementById('modal-manual-import').style.display='none'">CANCEL</button>
      <button class="btn btn-main" onclick="runManualImport()">IMPORT</button>
    </div>
  </div>
</div>

<div id="modal-new-ex" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title">New Exercise</h3>
    <input type="text" id="new-ex-name" placeholder="Exercise Name">
    <div style="margin-top:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="btn btn-main" onclick="confirmNewEx('str')">STRENGTH</button>
        <button class="btn btn-sec" style="border-color:var(--cardio); color:var(--cardio);" onclick="confirmNewEx('cardio')">CARDIO</button>
    </div>
    <button class="btn btn-ghost" style="margin-top:10px; width:100%; border:none;" onclick="document.getElementById('modal-new-ex').style.display='none'">CANCEL</button>
  </div>
</div>

<div id="modal-share" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title" style="text-align:center">Share</h3>
    <div id="qrcode"></div>
    <p style="font-size:10px; color:#666; text-align:center; margin-top:5px;">Scan to view bridge page</p>
    <button class="btn btn-main" style="margin-top:15px;" onclick="copyShareCode()">COPY CODE</button>
    <button class="btn btn-sec" style="margin-top:5px" onclick="document.getElementById('modal-share').style.display='none'">CLOSE</button>
  </div>
</div>

<div id="modal-set-opt" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title">Link Set</h3>
    <button class="btn btn-sec" style="border-color:var(--drop); color:var(--drop);" onclick="applySetType('drop')">üíß Drop Set</button>
    <button class="btn btn-sec" style="border-color:var(--super); color:var(--super);" onclick="applySetType('super')">üîó Superset</button>
    <button class="btn btn-sec" style="border-color:var(--assist); color:var(--assist);" onclick="applySetType('assist')">ü§ù Assisted</button>
    <button class="btn btn-sec" style="margin-top:20px" onclick="document.getElementById('modal-set-opt').style.display='none'">CANCEL</button>
  </div>
</div>

<div id="modal-input-overlay" class="modal-overlay"><div class="modal-box"><h3 id="modal-title" class="modal-title">Input</h3><input type="text" id="modal-input"><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;"><button class="btn btn-sec" onclick="closeInputModal()">CANCEL</button><button class="btn btn-main" id="modal-ok">SAVE</button></div></div></div>

<div id="modal-plate-calc" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title">Plate Math</h3>
    <input type="text" inputmode="decimal" id="calc-total" class="calc-input" value="45" onfocus="this.value=''" oninput="manualCalcUpdate(this.value)">
    
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button id="mode-bar" class="btn btn-sm" style="background:var(--success); color:black;" onclick="setCalcMode('bar')">BARBELL (2x)</button>
        <button id="mode-single" class="btn btn-sm" style="background:#333;" onclick="setCalcMode('single')">SINGLE (1x)</button>
    </div>
    
    <div class="plate-grid">
      <button class="p-btn" onclick="addPlate(45)">45</button>
      <button class="p-btn" onclick="addPlate(35)">35</button>
      <button class="p-btn" onclick="addPlate(25)">25</button>
      <button class="p-btn" onclick="addPlate(10)">10</button>
      <button class="p-btn" onclick="addPlate(5)">5</button>
      <button class="p-btn" onclick="addPlate(2.5)">2.5</button>
    </div>
    
    <button class="btn btn-sec" style="border-style:dashed; margin-bottom:10px;" onclick="useBW()">USE BODYWEIGHT (BW)</button>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn btn-sec" onclick="resetCalc()">RESET</button>
      <button class="btn btn-main" onclick="applyCalc()">USE</button>
    </div>
  </div>
</div>

<div id="modal-confirm-overlay" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">Confirm</h3><p id="confirm-desc" class="modal-desc">Sure?</p><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-sec" onclick="closeConfirmModal()">CANCEL</button><button class="btn btn-main" id="confirm-ok" style="background:#333">YES</button></div></div></div>
<div id="toast"><span class="toast-icon">‚úì</span> <span id="toast-msg">Saved</span></div>

<div id="view-program" class="view">
  <h1>NETGAINS <span class="brand-span">AI</span></h1>
  <p class="sub">ENGINE</p>
  <div style="background:#222; padding:15px; border-radius:12px; border:1px solid #333; margin-bottom:20px;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <input type="number" id="w" placeholder="Weight (lbs)">
        <input type="number" id="r" placeholder="Reps">
    </div>
    <button class="btn btn-main" onclick="genProgram()">Generate 8-Week Cycle</button>
  </div>
  <div id="schedule-area"></div>
</div>

<div id="view-log" class="view hidden">
  <h1>TRAINING LOG</h1>
  <p class="sub">TRACKER</p>

  <div id="split-manager">
      <div class="gym-selector-header" onclick="showGymManager()">
          <div><div class="gym-label">CURRENT LOCATION</div><div class="gym-name" id="current-gym-display">Main Gym</div></div>
          <div style="color:#666">‚ñº</div>
      </div>
      <button class="btn btn-sec" style="border:1px solid var(--accent); color:var(--accent); margin-bottom:20px;" onclick="openManualImport()">üì• IMPORT CODE</button>
      <div id="my-split-list"></div>
      <button class="btn btn-sec" style="border-style:dashed; color:#888;" onclick="promptAddDay()">+ NEW FOLDER</button>
  </div>

  <div id="gym-manager" class="hidden">
      <h3 style="color:var(--dim); font-size:12px; margin-bottom:15px;">GYMS</h3>
      <div id="gym-list"></div>
      <button class="btn btn-sec" style="border-style:dashed; margin-top:15px;" onclick="promptAddGym()">+ ADD NEW GYM</button>
      <button class="btn btn-sec" style="margin-top:20px;" onclick="closeGymManager()">‚Üê BACK</button>
  </div>

  <div id="session-logger" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display:flex; align-items:center;">
            <button class="btn btn-sec" onclick="closeSession()" style="width:auto; margin:0; padding:10px 15px;">‚Üê</button>
            <h2 id="session-title" style="margin:0 0 0 15px; color:var(--accent); font-size:20px;"></h2>
        </div>
        <button class="btn-ghost" onclick="clearCart()">START FRESH</button>
      </div>
      <div id="active-workout-area"></div>
      <button class="btn btn-main" onclick="finishSession()">FINISH & SAVE LOG</button>
      <div class="shelf-title">EXERCISE LIBRARY</div>
      <div id="tile-area" class="tile-grid"></div>
  </div>
</div>

<div id="view-tools" class="view hidden">
  <h1>TOOLS</h1>
  <p class="sub">UTILITIES</p>
  <div class="tool-box" style="background:#1a1a24; padding:20px; border-radius:15px; border:1px solid #333; text-align:center; margin-bottom:15px;">
      <h3 style="margin:0 0 15px 0; color:var(--accent)">DATA</h3>
      <button class="btn btn-sec" onclick="exportCSV()">DOWNLOAD CSV</button>
  </div>
  <div class="tool-box" style="background:#1a1a24; padding:20px; border-radius:15px; border:1px solid #333; text-align:center; margin-bottom:15px;">
      <h3 style="margin:0 0 15px 0; color:var(--accent)">REST TIMER</h3>
      <div style="font-size:45px; font-weight:900; margin:15px 0;" id="t-disp">00:00</div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
          <button class="btn btn-sec" onclick="startTimer(90)">90s</button>
          <button class="btn btn-sec" onclick="startTimer(180)">3m</button>
          <button class="btn btn-sec" onclick="startTimer(300)">5m</button>
      </div>
      <button class="btn btn-main" style="margin-top:10px; background:#333;" onclick="clearInterval(timer);document.getElementById('t-disp').innerText='00:00'">STOP</button>
  </div>
  <div class="tool-box" style="background:#1a1a24; padding:20px; border-radius:15px; border:1px solid #333; text-align:center; margin-bottom:15px;">
      <h3 style="margin:0 0 15px 0; color:var(--accent)">PLATE CALC</h3>
      <input type="number" id="pIn" placeholder="Weight (lbs)">
      <button class="btn btn-main" style="background:var(--success); color:black;" onclick="calcPlates()">CALCULATE</button>
      <div id="pOut" style="margin-top:15px;"></div>
  </div>
  <div class="tool-box" style="padding:20px; text-align:center;">
      <button class="btn btn-danger" onclick="nuke()">FACTORY RESET APP</button>
  </div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="switchTab('program', this)"><span>üìä</span> PROGRAM</button>
    <button class="nav-btn" onclick="switchTab('log', this)"><span>üìù</span> LOG</button>
    <button class="nav-btn" onclick="switchTab('tools', this)"><span>‚öí</span> TOOLS</button>
</div>

<script>
let appData=JSON.parse(localStorage.getItem('netGainsData')||'null');if(!appData){const d=JSON.parse(localStorage.getItem('myDays')||'[]'),l=JSON.parse(localStorage.getItem('myLibrary')||'{}');appData={currentGym:'Main Gym',gyms:{'Main Gym':{folders:d,library:l}},exTypes:{}};localStorage.setItem('netGainsData',JSON.stringify(appData))}if(!appData.exTypes)appData.exTypes={};
let activeCart=JSON.parse(localStorage.getItem('activeCart')||'[]'), sessionData=JSON.parse(localStorage.getItem('sessionData')||'{}'), history=JSON.parse(localStorage.getItem('liftHistory')||'{}'), globalLog=JSON.parse(localStorage.getItem('globalLog')||'[]');

const urlParams=new URLSearchParams(window.location.search), importData=urlParams.get('import');
if(importData){window.bridgeCode=importData;document.getElementById('modal-bridge').style.display='flex'}
function copyBridgeCode(){navigator.clipboard.writeText(window.bridgeCode).then(()=>{showToast("Copied!");document.getElementById('modal-bridge').style.display='none';window.history.replaceState({},document.title,"/")})}
function openManualImport(){document.getElementById('import-area').value="";document.getElementById('modal-manual-import').style.display='flex'}
function runManualImport(){const r=document.getElementById('import-area').value;if(!r)return;try{const d=JSON.parse(atob(r)),g=getCurrentGymData();if(!g.folders.includes(d.name))g.folders.push(d.name);g.library[d.name]=d.exs;saveAppData();renderDays();document.getElementById('modal-manual-import').style.display='none';showToast("Imported!")}catch(e){showToast("Invalid")}}
function shareFolder(n){const g=getCurrentGymData(),d={name:n,exs:g.library[n]||[]},s=btoa(JSON.stringify(d)),l=window.location.origin+window.location.pathname+"?import="+s;document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById("qrcode"),{text:l,width:128,height:128});window.shareCode=s;document.getElementById('modal-share').style.display='flex'}
function copyShareCode(){navigator.clipboard.writeText(window.shareCode).then(()=>showToast("Copied!"))}

renderDays();
function switchTab(id,b){document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));document.getElementById('view-'+id).classList.remove('hidden');document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active')}
function getCurrentGymData(){if(!appData.gyms[appData.currentGym])appData.gyms[appData.currentGym]={folders:[],library:{}};return appData.gyms[appData.currentGym]}
function showGymManager(){document.getElementById('split-manager').classList.add('hidden');document.getElementById('gym-manager').classList.remove('hidden');renderGymList()}
function closeGymManager(){document.getElementById('gym-manager').classList.add('hidden');document.getElementById('split-manager').classList.remove('hidden')}
function renderGymList(){const d=document.getElementById('gym-list');d.innerHTML="";Object.keys(appData.gyms).forEach(g=>{const a=g===appData.currentGym;d.innerHTML+=`<div class="day-card" style="${a?'border:1px solid var(--accent)':''}"><div style="flex-grow:1;cursor:pointer;" onclick="selectGym('${g}')"><b>${g}</b>${a?' <span style="font-size:9px;background:var(--accent);padding:2px 4px;border-radius:4px;">ACTIVE</span>':''}</div><div style="display:flex;gap:8px;"><button class="icon-btn" onclick="delGym('${g}')">‚úï</button></div></div>`})}
function selectGym(n){appData.currentGym=n;saveAppData();renderDays();closeGymManager();showToast("Switched")}
function promptAddGym(){openInputModal("New Gym","Name",v=>{if(v){appData.gyms[v]={folders:[],library:{}};selectGym(v)}})}
function delGym(n){if(Object.keys(appData.gyms).length<=1)return;showConfirm("Delete?",()=>{delete appData.gyms[n];selectGym(Object.keys(appData.gyms)[0])})}
function renderDays(){const g=getCurrentGymData();document.getElementById('current-gym-display').innerText=appData.currentGym;const l=document.getElementById('my-split-list');l.innerHTML="";g.folders.forEach(d=>{const c=(g.library[d]||[]).length;l.innerHTML+=`<div class="day-card"><div style="flex-grow:1;cursor:pointer;" onclick="openSession('${d}')"><b>${d}</b><br><span style="font-size:11px;color:#666;">${c} Ex</span></div><div style="display:flex;gap:5px;"><button class="icon-btn" onclick="shareFolder('${d}')">‚û¶</button><button class="icon-btn" onclick="renameFolder('${d}')">‚úé</button><button class="icon-btn" onclick="delFolder('${d}')">‚úï</button></div></div>`})}

let currentFolder="";
function openSession(d){currentFolder=d;document.getElementById('split-manager').classList.add('hidden');document.getElementById('session-logger').classList.remove('hidden');document.getElementById('session-title').innerText=d;renderCart();renderShelf()}
function closeSession(){document.getElementById('session-logger').classList.add('hidden');document.getElementById('split-manager').classList.remove('hidden')}
function clearCart(){showConfirm("Clear?",()=>{activeCart=[];sessionData={};saveSession();renderCart()})}

function renderCart(){
    const area=document.getElementById('active-workout-area');area.innerHTML="";
    if(activeCart.length===0){area.innerHTML="<div style='text-align:center;padding:30px;color:#555;'>Empty Workout</div>";return}
    activeCart.forEach((ex,exIdx)=>{
        const isC=appData.exTypes[ex]==='cardio', sets=sessionData[ex]||[], isLR=sessionData[ex+'_LR']===true, best=history[ex]||'No history';
        let h=`<div class="ex-top"><div><span class="ex-name">${ex}</span><div class="ex-hist">BEST: ${best}</div></div><div class="ex-tools">${!isC?`<div class="toggle-lr ${isLR?'active':''}" onclick="toggleLR('${ex}')">L+R</div>`:''}<button onclick="removeExFromCart('${ex}')" style="background:none;border:none;color:#555;">‚úï</button></div></div>`;
        let r="";
        if(isC){
            sets.forEach((s,i)=>{
                r+=`<div class="cardio-row"><span class="set-num">${i+1}</span><div class="input-wrapper"><input type="text" inputmode="decimal" value="${s.w}" onchange="updateSet('${ex}',${i},'w',this.value)"><span class="input-unit">MIN</span></div><div class="input-wrapper"><input type="text" inputmode="decimal" value="${s.r}" onchange="updateSet('${ex}',${i},'r',this.value)"><span class="input-unit">MI</span></div><div class="input-wrapper"><input type="text" inputmode="decimal" value="${s.hr||''}" onchange="updateSet('${ex}',${i},'hr',this.value)"><span class="input-unit">BPM</span></div><button class="del-btn" onclick="removeSet('${ex}',${i})">‚úï</button></div>`
            });
        } else {
            let i=0,cnt=1;
            while(i<sets.length){
                let s=sets[i], ns=sets[i+1], lbl=cnt;
                if(s.side){lbl=`${cnt} ${s.side}`;if(s.side==='R')cnt++;}else{cnt++}
                if(s.type==='drop_parent'&&ns&&ns.type==='drop_child'){
                    r+=`<div class="set-group-box set-group-drop">${rr(ex,exIdx,i,s,lbl)}${rr(ex,exIdx,i+1,ns,"DROP")}</div>`;i+=2;
                } else if(s.type==='super_parent'&&ns&&ns.type==='super_child'){
                    r+=`<div class="set-group-box set-group-super">${rr(ex,exIdx,i,s,lbl)}${rr(ex,exIdx,i+1,ns,"SUPER")}</div>`;i+=2;
                } else if(s.type==='assist_parent'&&ns&&ns.type==='assist_child'){
                    r+=`<div class="set-group-box set-group-assist">${rr(ex,exIdx,i,s,lbl)}${rr(ex,exIdx,i+1,ns,"ASST")}</div>`;i+=2;
                } else {
                    r+=`<div class="set-container">${rr(ex,exIdx,i,s,lbl)}</div>`;i++;
                }
            }
        }
        area.innerHTML+=`<div class="ex-card">${h}<div id="sets-${ex}">${r}</div><button class="btn btn-sec btn-sm" onclick="addSet('${ex}')">+ ADD SET</button></div>`
    });
}
// Render Row Helper (rr) - Uses Direct ID link for calc
function rr(ex,exIdx,i,s,lbl){
    const uid=`input_${exIdx}_${i}`; const safeEx=ex.replace(/'/g,"\\'");
    return `<div class="set-row"><div style="display:flex;flex-direction:column;align-items:center;"><span class="set-num">${lbl}</span></div><div class="input-wrapper"><input type="text" inputmode="decimal" id="${uid}" value="${s.w}" onchange="updateSet('${safeEx}',${i},'w',this.value)"><span class="input-unit">LBS</span></div><button class="calc-btn" onclick="openCalc('${uid}')">üßÆ</button><div class="input-wrapper"><input type="text" inputmode="decimal" value="${s.r}" onchange="updateSet('${safeEx}',${i},'r',this.value)"><span class="input-unit">REPS</span></div><button class="menu-btn" onclick="openSetOpt('${safeEx}',${i})">...</button><button class="del-btn" onclick="removeSet('${safeEx}',${i})">‚úï</button></div>`
}

let optTarget=null;
function openSetOpt(ex,i){optTarget={ex,i};document.getElementById('modal-set-opt').style.display='flex'}
function applySetType(t){if(optTarget){const{ex,i}=optTarget,s=sessionData[ex][i];let nw=s.w;if(t==='drop')nw="";const ns={w:nw,r:'',type:t+'_child'};sessionData[ex].splice(i+1,0,ns);s.type=t+'_parent';saveSession();renderCart();document.getElementById('modal-set-opt').style.display='none'}}
function toggleLR(e){const c=sessionData[e+'_LR']===true;sessionData[e+'_LR']=!c;saveSession();renderCart()}
function addSet(e){if(!sessionData[e])sessionData[e]=[];if(sessionData[e+'_LR']===true){sessionData[e].push({w:'',r:'',side:'L'});sessionData[e].push({w:'',r:'',side:'R'})}else{sessionData[e].push({w:'',r:''})}saveSession();renderCart()}
function removeSet(e,i){sessionData[e].splice(i,1);saveSession();renderCart()}
function updateSet(e,i,f,v){if(!sessionData[e][i])return;sessionData[e][i][f]=v;saveSession()}

function renderShelf(){const a=document.getElementById('tile-area'),g=getCurrentGymData(),l=g.library[currentFolder]||[];a.innerHTML=`<button class="tile tile-add" onclick="promptNewEx()">+ NEW</button>`;l.forEach(e=>{a.innerHTML+=`<div class="tile" onclick="addToCart('${e}')">${e}</div>`})}
function addToCart(e){if(!activeCart.includes(e)){activeCart.push(e);if(!sessionData[e])sessionData[e]=[{w:'',r:''}];saveSession();renderCart()}}
function removeExFromCart(e){activeCart=activeCart.filter(x=>x!==e);delete sessionData[e];saveSession();renderCart()}
function promptNewEx(){document.getElementById('new-ex-name').value="";document.getElementById('modal-new-ex').style.display='flex'}
function confirmNewEx(t){const v=document.getElementById('new-ex-name').value;if(v){const g=getCurrentGymData();if(!g.library[currentFolder])g.library[currentFolder]=[];g.library[currentFolder].push(v);appData.exTypes[v]=t;saveAppData();renderShelf();addToCart(v)}document.getElementById('modal-new-ex').style.display='none'}

function saveSession(){localStorage.setItem('activeCart',JSON.stringify(activeCart));localStorage.setItem('sessionData',JSON.stringify(sessionData))}
function saveAppData(){localStorage.setItem('netGainsData',JSON.stringify(appData))}
function finishSession(){showConfirm("Save?",()=>{const t=new Date().toISOString().split('T')[0];activeCart.forEach(e=>{const c=appData.exTypes[e]==='cardio',s=sessionData[e]||[];if(c){s.forEach(x=>{const m=parseFloat(x.w),d=parseFloat(x.r);if(m&&d){const p=(m/d).toFixed(2);globalLog.push({date:t,ex:e,w:m,r:d,rm:p,hr:x.hr,type:'cardio'});history[e]=`${p} /mi`}})}else{let b=0,bs="";s.forEach(x=>{const w=parseFloat(x.w),r=parseFloat(x.r);if(!isNaN(w)&&!isNaN(r)){const e1=w*(1+(0.033*r));if(e1>b){b=e1;bs=`${x.w} lbs x ${r}`}globalLog.push({date:t,ex:e,w:w,r:r,rm:Math.round(e1),type:x.type||'',side:x.side||''})}else if(x.w==="BW"&&r){globalLog.push({date:t,ex:e,w:"BW",r:r,rm:0,type:x.type||'',side:x.side||''})}});if(bs)history[e]=bs}});localStorage.setItem('liftHistory',JSON.stringify(history));localStorage.setItem('globalLog',JSON.stringify(globalLog));activeCart=[];sessionData={};saveSession();closeSession();showToast("Saved")})}

function promptAddDay(){openInputModal("Folder","Name",v=>{if(v){const g=getCurrentGymData();if(!g.folders.includes(v))g.folders.push(v);saveAppData();renderDays()}})}
function renameFolder(o){openInputModal("Rename",o,v=>{if(v&&v!==o){const g=getCurrentGymData(),i=g.folders.indexOf(o);if(i!==-1)g.folders[i]=v;if(g.library[o]){g.library[v]=g.library[o];delete g.library[o]}saveAppData();renderDays()}})}
function delFolder(n){showConfirm("Delete?",()=>{const g=getCurrentGymData();g.folders=g.folders.filter(d=>d!==n);delete g.library[n];saveAppData();renderDays()})}
function showToast(m){const t=document.getElementById('toast');document.getElementById('toast-msg').innerText=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
function openInputModal(t,p,c){const m=document.getElementById('modal-input-overlay'),i=document.getElementById('modal-input'),b=document.getElementById('modal-ok');document.getElementById('modal-title').innerText=t;i.value="";i.placeholder=p;m.style.display='flex';i.focus();let n=b.cloneNode(true);b.parentNode.replaceChild(n,b);n.addEventListener('click',()=>{m.style.display='none';c(i.value)})}
function closeInputModal(){document.getElementById('modal-input-overlay').style.display='none'}
function showConfirm(m,c){const d=document.getElementById('modal-confirm-overlay'),b=document.getElementById('confirm-ok');document.getElementById('confirm-desc').innerText=m;d.style.display='flex';let n=b.cloneNode(true);b.parentNode.replaceChild(n,b);n.addEventListener('click',()=>{d.style.display='none';c()})}
function closeConfirmModal(){document.getElementById('modal-confirm-overlay').style.display='none'}
function nuke(){showConfirm("DELETE ALL?",()=>{localStorage.clear();location.reload()})}
function exportCSV(){if(globalLog.length===0){showToast("No data");return}let c="Date,Exercise,Weight,Reps,Side,Type,HR\n";globalLog.forEach(l=>{c+=`${l.date},${l.ex},${l.w},${l.r},${l.side||''},${l.type||''},${l.hr||''}\n`});const b=document.createElement('a');b.href=encodeURI("data:text/csv;charset=utf-8,"+c);b.download="netgains_data.csv";document.body.appendChild(b);b.click()}

// PLATE CALC LOGIC (FIXED)
let targetInputId = null; // Store ID string here
let calcSideWeight=0, calcBar=45, calcMode='bar';

function openCalc(uid){
    targetInputId = uid; // Save the ID of the input box
    calcSideWeight=0; 
    setCalcMode('bar'); 
    document.getElementById('modal-plate-calc').style.display='flex'; 
}
function calcPlates(){ targetInputId=null; calcSideWeight=0; setCalcMode('bar'); document.getElementById('modal-plate-calc').style.display='flex'; }

function setCalcMode(m){
    calcMode=m; calcBar=(m==='bar')?45:0;
    document.getElementById('mode-bar').style.background=(m==='bar')?'var(--success)':'#333';
    document.getElementById('mode-bar').style.color=(m==='bar')?'black':'white';
    document.getElementById('mode-single').style.background=(m==='single')?'var(--success)':'#333';
    document.getElementById('mode-single').style.color=(m==='single')?'black':'white';
    updateCalcDisplay();
}
function addPlate(w){calcSideWeight+=w;updateCalcDisplay()}
function resetCalc(){calcSideWeight=0;updateCalcDisplay()}
function updateCalcDisplay(){
    let t=0; if(calcMode==='bar')t=(calcSideWeight*2)+calcBar; else t=calcSideWeight;
    document.getElementById('calc-total').value=t;
}
function manualCalcUpdate(v){const n=parseFloat(v);if(!isNaN(n)){if(calcMode==='bar'){calcSideWeight=(n-calcBar)/2}else{calcSideWeight=n}}}

function applyCalc(){
    if(targetInputId){
        const el = document.getElementById(targetInputId);
        if(el){
            el.value = document.getElementById('calc-total').value;
            el.dispatchEvent(new Event('change')); // Trigger save
        }
    }
    document.getElementById('modal-plate-calc').style.display='none';
}
function useBW(){
    if(targetInputId){
        const el = document.getElementById(targetInputId);
        if(el){
            el.value = "BW";
            el.dispatchEvent(new Event('change'));
        }
    }
    document.getElementById('modal-plate-calc').style.display='none';
}

function genProgram(){const w=parseFloat(document.getElementById('w').value),r=parseFloat(document.getElementById('r').value);if(!w||!r)return;const rnd=n=>Math.round(n/5)*5,max=rnd(w*(1+(0.033*r))),rm5=rnd(max*0.87),rm3=rnd(max*0.93);const weeks=[{n:1,t:"BASE",b:rm5,m:.85,s:4,r:6},{n:2,t:"LOAD",b:rm5,m:.9,s:4,r:6},{n:3,t:"INTENSE",b:rm5,m:.95,s:4,r:6},{n:4,t:"PEAK",b:rm5,m:1.05,s:4,r:6},{n:5,t:"UNLOAD",b:rm5,m:.85,s:2,r:4,f:.9},{n:6,t:"SPEED",b:rm3,m:1,s:3,r:4,w:.75,f:.85},{n:7,t:"FORCE",b:rm3,m:1,s:3,r:4,w:.85,f:.9},{n:8,t:"MAX",b:rm3,m:1,s:3,r:4,w:.7,f:.85}];let h=`<div style="text-align:center;margin-bottom:20px;color:var(--success);font-weight:bold;border:1px solid #333;padding:10px;border-radius:10px;">EST 1RM: ${max} LBS</div>`;weeks.forEach(k=>{let m=rnd(k.b*k.m),wL=rnd(m*(k.w||.85)),f=rnd(m*(k.f||.95));if(k.n===4)wL=rnd(m*.8);h+=`<div class="week"><div class="week-head"><span>Week ${k.n}</span><span style="color:#ff4757">${k.t}</span></div><div class="day-row"><div><b>Mon</b></div><div>${m} lbs ${k.s}x${k.r} <span class="tag tag-h">H</span></div></div><div class="day-row"><div><b>Wed</b></div><div>${wL} lbs ${k.s}x${k.r} <span class="tag tag-l">L</span></div></div><div class="day-row"><div><b>Fri</b></div><div>${f} lbs ${k.s}x${k.r} <span class="tag tag-m">M</span></div></div></div>`});document.getElementById('schedule-area').innerHTML=h}
let timer;function startTimer(s){clearInterval(timer);const end=Date.now()+s*1000;timer=setInterval(()=>{const r=Math.round((end-Date.now())/1000);if(r<0){clearInterval(timer);document.getElementById('t-disp').innerText="DONE";return}const m=Math.floor(r/60),rs=r%60;document.getElementById('t-disp').innerText=`${m}:${rs<10?'0':''}${rs}`},1000)}
</script>
</body>
</html>
